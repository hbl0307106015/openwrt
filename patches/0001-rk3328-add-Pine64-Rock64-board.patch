From a599b4b4470dcd5370b577a67f18c166fcffdd26 Mon Sep 17 00:00:00 2001
From: Lucian Cristian <lucian.cristian@gmail.com>
Date: Tue, 21 Apr 2020 00:13:00 +0300
Subject: [PATCH] rk3328: add Pine64 Rock64 board

also update ATF rockchip to final release

Signed-off-by: Lucian Cristian <lucian.cristian@gmail.com>
---
 .../arm-trusted-firmware-rockchip/Makefile    |   6 +-
 package/boot/uboot-rockchip/Makefile          |  20 +-
 ...p-Avoid-using-libfdt-with-of-platdata.diff |  65 +++
 ...c-Avoid-using-libfdt-with-of-platdata.diff |  17 +
 ...-pinctrl-Disable-full-pinctrl-for-SPL.diff |  48 ++
 ...ude-ofnode-functions-with-of-platdata.diff |  41 ++
 ...TPL-to-use-of-platdata-without-libfdt.diff |  22 +
 package/kernel/linux/modules/input.mk         |  61 ++-
 package/kernel/linux/modules/sound.mk         |  36 ++
 package/kernel/linux/modules/video.mk         |  79 +++
 target/linux/generic/config-5.4               |   9 +
 .../rockchip/armv8/base-files/etc/inittab     |   6 +
 target/linux/rockchip/armv8/config-5.4        |  68 ++-
 target/linux/rockchip/image/Makefile          |   4 +-
 target/linux/rockchip/image/armv8.mk          |  10 +
 target/linux/rockchip/image/mmc.bootscript    |  14 +-
 .../0001-add_sound_rk3328_rock64.patch        | 170 ++++++
 ...-rock64_fixed_regulator_gpio_warning.patch |  41 ++
 .../0003-rk3328_rock64_update_gpu_node.patch  |  75 +++
 .../0004-rk3328_add_sdmmc_ext_node.patch      |  34 ++
 .../0005-rk3328_add_idle_state.patch          |  71 +++
 .../0006-rk3328_add_mmc_reset.patch           |  40 ++
 .../patches-5.4/0007-add_gpu_supply.patch     |  27 +
 ...0008-rock64_add_spi_flash_partitions.patch |  39 ++
 .../0009-rk3328_add_rkvdec_power_domain.patch |  32 ++
 ...0011-rk3328_rock64_fix_vccio4_supply.patch |  22 +
 .../0012-rk3328_fix_wrong_mmc_shift.patch     |  48 ++
 .../0014-remove_deprecated_g_dma.patch        |  52 ++
 .../0015-bus_to_rockchip_amba_nodenames.patch |  45 ++
 ...remove_clock-names_property_from_usb.patch |  82 +++
 .../patches-5.4/0020-misc_supply_fixes.patch  |  97 ++++
 .../patches-5.4/0021-usb3_fixes.patch         | 126 +++++
 ...ke_RK3328_GPIO_MUTE_control_explicit.patch |  50 ++
 ...ke_RK3328_GPIO_MUTE_control_explicit.patch | 111 ++++
 ...ke_RK3328_GPIO_MUTE_control_explicit.patch |  30 ++
 .../patches-5.4/0030-hdmi_cec_fixes.patch     | 510 ++++++++++++++++++
 .../patches-5.4/0031-mmc_rename.patch         |  56 ++
 .../patches-5.4/0032-add_hwmon_support.patch  |  92 ++++
 .../patches-5.4/0033-add_mmc_poweroff.patch   |  94 ++++
 .../0040-fix_TX_checksumm_offload.patch       |  73 +++
 40 files changed, 2503 insertions(+), 20 deletions(-)
 create mode 100644 package/boot/uboot-rockchip/patches/U-Boot-v4-1-5-rockchip-Avoid-using-libfdt-with-of-platdata.diff
 create mode 100644 package/boot/uboot-rockchip/patches/U-Boot-v4-2-5-omap-mmc-Avoid-using-libfdt-with-of-platdata.diff
 create mode 100644 package/boot/uboot-rockchip/patches/U-Boot-v4-3-5-rockchip-pinctrl-Disable-full-pinctrl-for-SPL.diff
 create mode 100644 package/boot/uboot-rockchip/patches/U-Boot-v4-4-5-dm-core-Don-t-include-ofnode-functions-with-of-platdata.diff
 create mode 100644 package/boot/uboot-rockchip/patches/U-Boot-v4-5-5-spl-Allow-SPL-TPL-to-use-of-platdata-without-libfdt.diff
 create mode 100644 target/linux/rockchip/armv8/base-files/etc/inittab
 create mode 100644 target/linux/rockchip/patches-5.4/0001-add_sound_rk3328_rock64.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0002-rock64_fixed_regulator_gpio_warning.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0003-rk3328_rock64_update_gpu_node.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0004-rk3328_add_sdmmc_ext_node.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0005-rk3328_add_idle_state.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0006-rk3328_add_mmc_reset.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0007-add_gpu_supply.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0008-rock64_add_spi_flash_partitions.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0009-rk3328_add_rkvdec_power_domain.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0011-rk3328_rock64_fix_vccio4_supply.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0012-rk3328_fix_wrong_mmc_shift.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0014-remove_deprecated_g_dma.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0015-bus_to_rockchip_amba_nodenames.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0016-remove_clock-names_property_from_usb.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0020-misc_supply_fixes.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0021-usb3_fixes.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0022-Make_RK3328_GPIO_MUTE_control_explicit.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0023-Make_RK3328_GPIO_MUTE_control_explicit.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0024-Make_RK3328_GPIO_MUTE_control_explicit.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0030-hdmi_cec_fixes.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0031-mmc_rename.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0032-add_hwmon_support.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0033-add_mmc_poweroff.patch
 create mode 100644 target/linux/rockchip/patches-5.4/0040-fix_TX_checksumm_offload.patch

diff --git a/package/boot/arm-trusted-firmware-rockchip/Makefile b/package/boot/arm-trusted-firmware-rockchip/Makefile
index a1c9e120e7..b712a3530a 100644
--- a/package/boot/arm-trusted-firmware-rockchip/Makefile
+++ b/package/boot/arm-trusted-firmware-rockchip/Makefile
@@ -8,12 +8,12 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=arm-trusted-firmware-rockchip
-PKG_VERSION:=2.3-rc0
+PKG_VERSION:=2.3
 PKG_RELEASE:=1
 
 PKG_SOURCE:=atf-v$(PKG_VERSION).tar.gz
 PKG_SOURCE_URL:=https://github.com/atf-builds/atf/releases/download/v$(PKG_VERSION)/atf-v$(PKG_VERSION).tar.gz?
-PKG_HASH:=8d0a2bd18adf54f9cf6fe923d10f21c1d21f42a15067757333ff8989b25f100a
+PKG_HASH:=bf352298743aed594cf2958dd588e06ab6713fc514bb6f809bf55a85a87134c1
 
 PKG_LICENSE:=BSD-3-Clause
 PKG_LICENSE_FILES:=license.md
@@ -40,7 +40,7 @@ endef
 
 define Build/InstallDev
 	$(INSTALL_DIR) -p $(STAGING_DIR_IMAGE)
-	$(CP) $(PKG_BUILD_DIR)/rk3399_bl31.elf $(STAGING_DIR_IMAGE)/bl31.elf
+	$(CP) $(PKG_BUILD_DIR)/rk*.elf $(STAGING_DIR_IMAGE)/
 endef
 
 define Package/arm-trusted-firmware-rockchip/install
diff --git a/package/boot/uboot-rockchip/Makefile b/package/boot/uboot-rockchip/Makefile
index b99d051fcf..86c3785add 100644
--- a/package/boot/uboot-rockchip/Makefile
+++ b/package/boot/uboot-rockchip/Makefile
@@ -13,6 +13,7 @@ PKG_MAINTAINER:=Tobias Maedel <openwrt@tbspace.de>
 
 include $(INCLUDE_DIR)/u-boot.mk
 include $(INCLUDE_DIR)/package.mk
+PKG_BUILD_DEPENDS:=arm-trusted-firmware-rockchip
 
 define U-Boot/Default
   BUILD_TARGET:=rockchip
@@ -25,22 +26,29 @@ define U-Boot/rockpro64-rk3399
   NAME:=RockPro64
   BUILD_DEVICES:= \
     pine64_rockpro64
-  DEPENDS:=+PACKAGE_u-boot-rockpro64-rk3399:arm-trusted-firmware-rockchip
-  PKG_BUILD_DEPENDS:=arm-trusted-firmware-rockchip
+  BL31=$(STAGING_DIR_IMAGE)/rk3399_bl31.elf
+endef
+
+define U-Boot/rock64-rk3328
+  BUILD_SUBTARGET:=armv8
+  NAME:=Rock64
+  BUILD_DEVICES:= \
+    pine64_rock64
+  BL31=$(STAGING_DIR_IMAGE)/rk3328_bl31.elf
 endef
 
 UBOOT_TARGETS := \
-  rockpro64-rk3399
+  rockpro64-rk3399 \
+  rock64-rk3328
 
 UBOOT_CONFIGURE_VARS += USE_PRIVATE_LIBGCC=yes
 
 UBOOT_MAKE_FLAGS += \
-  BL31=$(STAGING_DIR_IMAGE)/bl31.elf
+  BL31=$(BL31)
 
 define Build/Configure
-	$(SED) s/subdir.*pylibfdt//g $(PKG_BUILD_DIR)/scripts/dtc/Makefile
+	 echo CONFIG_CMD_SETEXPR=y >> $(PKG_BUILD_DIR)/configs/$(UBOOT_CONFIG)_defconfig
 	$(call Build/Configure/U-Boot)
-
 	$(SED) 's#CONFIG_MKIMAGE_DTC_PATH=.*#CONFIG_MKIMAGE_DTC_PATH="$(PKG_BUILD_DIR)/scripts/dtc/dtc"#g' $(PKG_BUILD_DIR)/.config
 	echo 'CONFIG_IDENT_STRING=" OpenWrt"' >> $(PKG_BUILD_DIR)/.config
 endef
diff --git a/package/boot/uboot-rockchip/patches/U-Boot-v4-1-5-rockchip-Avoid-using-libfdt-with-of-platdata.diff b/package/boot/uboot-rockchip/patches/U-Boot-v4-1-5-rockchip-Avoid-using-libfdt-with-of-platdata.diff
new file mode 100644
index 0000000000..d118b4f088
--- /dev/null
+++ b/package/boot/uboot-rockchip/patches/U-Boot-v4-1-5-rockchip-Avoid-using-libfdt-with-of-platdata.diff
@@ -0,0 +1,65 @@
+diff --git a/drivers/clk/rockchip/clk_rk3328.c b/drivers/clk/rockchip/clk_rk3328.c
+index a89e2ecc4a..e86c17e6d6 100644
+--- a/drivers/clk/rockchip/clk_rk3328.c
++++ b/drivers/clk/rockchip/clk_rk3328.c
+@@ -669,6 +669,10 @@ static int rk3328_gmac2io_set_parent(struct clk *clk, struct clk *parent)
+ 		return 0;
+ 	}
+ 
++	/* FIXME: Device tree should be read in ofdata_to_platdata() */
++	if (CONFIG_IS_ENABLED(OF_PLATDATA))
++		return -EDEADLK;
++
+ 	/*
+ 	 * Otherwise, we need to check the clock-output-names of the
+ 	 * requested parent to see if the requested id is "gmac_clkin".
+@@ -706,6 +710,10 @@ static int rk3328_gmac2io_ext_set_parent(struct clk *clk, struct clk *parent)
+ 		return 0;
+ 	}
+ 
++	/* FIXME: Device tree should be read in ofdata_to_platdata() */
++	if (CONFIG_IS_ENABLED(OF_PLATDATA))
++		return -EDEADLK;
++
+ 	/*
+ 	 * Otherwise, we need to check the clock-output-names of the
+ 	 * requested parent to see if the requested id is "gmac_clkin".
+@@ -762,9 +770,11 @@ static int rk3328_clk_probe(struct udevice *dev)
+ 
+ static int rk3328_clk_ofdata_to_platdata(struct udevice *dev)
+ {
+-	struct rk3328_clk_priv *priv = dev_get_priv(dev);
++	if (!CONFIG_IS_ENABLED(OF_PLATDATA)) {
++		struct rk3328_clk_priv *priv = dev_get_priv(dev);
+ 
+-	priv->cru = dev_read_addr_ptr(dev);
++		priv->cru = dev_read_addr_ptr(dev);
++	}
+ 
+ 	return 0;
+ }
+diff --git a/drivers/pinctrl/rockchip/pinctrl-rockchip-core.c b/drivers/pinctrl/rockchip/pinctrl-rockchip-core.c
+index 80dc431d20..dccc54e95f 100644
+--- a/drivers/pinctrl/rockchip/pinctrl-rockchip-core.c
++++ b/drivers/pinctrl/rockchip/pinctrl-rockchip-core.c
+@@ -383,8 +383,8 @@ static int rockchip_pinconf_prop_name_to_param(const char *property,
+ 	return -EPERM;
+ }
+ 
+-static int rockchip_pinctrl_set_state(struct udevice *dev,
+-				      struct udevice *config)
++static int __maybe_unused rockchip_pinctrl_set_state(struct udevice *dev,
++						     struct udevice *config)
+ {
+ 	struct rockchip_pinctrl_priv *priv = dev_get_priv(dev);
+ 	struct rockchip_pin_ctrl *ctrl = priv->ctrl;
+@@ -474,7 +474,9 @@ static int rockchip_pinctrl_set_state(struct udevice *dev,
+ }
+ 
+ const struct pinctrl_ops rockchip_pinctrl_ops = {
++#if !CONFIG_IS_ENABLED(PLATDATA)
+ 	.set_state			= rockchip_pinctrl_set_state,
++#endif
+ 	.get_gpio_mux			= rockchip_pinctrl_get_gpio_mux,
+ };
+ 
diff --git a/package/boot/uboot-rockchip/patches/U-Boot-v4-2-5-omap-mmc-Avoid-using-libfdt-with-of-platdata.diff b/package/boot/uboot-rockchip/patches/U-Boot-v4-2-5-omap-mmc-Avoid-using-libfdt-with-of-platdata.diff
new file mode 100644
index 0000000000..c97b3456c2
--- /dev/null
+++ b/package/boot/uboot-rockchip/patches/U-Boot-v4-2-5-omap-mmc-Avoid-using-libfdt-with-of-platdata.diff
@@ -0,0 +1,17 @@
+diff --git a/drivers/mmc/davinci_mmc.c b/drivers/mmc/davinci_mmc.c
+index 0d63279db0..79a7f50d25 100644
+--- a/drivers/mmc/davinci_mmc.c
++++ b/drivers/mmc/davinci_mmc.c
+@@ -507,6 +507,12 @@ static int davinci_mmc_probe(struct udevice *dev)
+ 		priv->version = data->version;
+ 	}
+ 
++	/* FIXME: Cannot read from device tree with of-platdata */
++	if (CONFIG_IS_ENABLED(OF_PLATDATA)) {
++		printf("Please fix this driver to use of-platdata");
++		return -ENOSYS;
++	}
++
+ 	priv->reg_base = (struct davinci_mmc_regs *)dev_read_addr(dev);
+ 	priv->input_clk = clk_get(DAVINCI_MMCSD_CLKID);
+ 
diff --git a/package/boot/uboot-rockchip/patches/U-Boot-v4-3-5-rockchip-pinctrl-Disable-full-pinctrl-for-SPL.diff b/package/boot/uboot-rockchip/patches/U-Boot-v4-3-5-rockchip-pinctrl-Disable-full-pinctrl-for-SPL.diff
new file mode 100644
index 0000000000..a475b1e0c0
--- /dev/null
+++ b/package/boot/uboot-rockchip/patches/U-Boot-v4-3-5-rockchip-pinctrl-Disable-full-pinctrl-for-SPL.diff
@@ -0,0 +1,48 @@
+diff --git a/configs/chromebit_mickey_defconfig b/configs/chromebit_mickey_defconfig
+index 6a1ea049f9..2e93344bda 100644
+--- a/configs/chromebit_mickey_defconfig
++++ b/configs/chromebit_mickey_defconfig
+@@ -72,6 +72,7 @@ CONFIG_SPI_FLASH_GIGADEVICE=y
+ CONFIG_PINCTRL=y
+ CONFIG_PINCONF=y
+ CONFIG_SPL_PINCTRL=y
++# CONFIG_SPL_PINCTRL_FULL is not set
+ # CONFIG_SPL_PINMUX is not set
+ CONFIG_SPL_PINCONF=y
+ CONFIG_DM_PMIC=y
+diff --git a/configs/chromebook_jerry_defconfig b/configs/chromebook_jerry_defconfig
+index 1b7751cc6a..2ed9921e4e 100644
+--- a/configs/chromebook_jerry_defconfig
++++ b/configs/chromebook_jerry_defconfig
+@@ -75,6 +75,7 @@ CONFIG_SPI_FLASH_GIGADEVICE=y
+ CONFIG_PINCTRL=y
+ CONFIG_PINCONF=y
+ CONFIG_SPL_PINCTRL=y
++# CONFIG_SPL_PINCTRL_FULL is not set
+ # CONFIG_SPL_PINMUX is not set
+ CONFIG_SPL_PINCONF=y
+ CONFIG_DM_PMIC=y
+diff --git a/configs/chromebook_minnie_defconfig b/configs/chromebook_minnie_defconfig
+index 28ae61847f..c62ebaca31 100644
+--- a/configs/chromebook_minnie_defconfig
++++ b/configs/chromebook_minnie_defconfig
+@@ -74,6 +74,7 @@ CONFIG_SPI_FLASH_GIGADEVICE=y
+ CONFIG_PINCTRL=y
+ CONFIG_PINCONF=y
+ CONFIG_SPL_PINCTRL=y
++# CONFIG_SPL_PINCTRL_FULL is not set
+ # CONFIG_SPL_PINMUX is not set
+ CONFIG_SPL_PINCONF=y
+ CONFIG_DM_PMIC=y
+diff --git a/configs/chromebook_speedy_defconfig b/configs/chromebook_speedy_defconfig
+index 0284e31bcf..fd707e283d 100644
+--- a/configs/chromebook_speedy_defconfig
++++ b/configs/chromebook_speedy_defconfig
+@@ -74,6 +74,7 @@ CONFIG_SPI_FLASH_GIGADEVICE=y
+ CONFIG_PINCTRL=y
+ CONFIG_PINCONF=y
+ CONFIG_SPL_PINCTRL=y
++# CONFIG_SPL_PINCTRL_FULL is not set
+ CONFIG_DM_PMIC=y
+ # CONFIG_SPL_PMIC_CHILDREN is not set
+ CONFIG_PMIC_RK8XX=y
diff --git a/package/boot/uboot-rockchip/patches/U-Boot-v4-4-5-dm-core-Don-t-include-ofnode-functions-with-of-platdata.diff b/package/boot/uboot-rockchip/patches/U-Boot-v4-4-5-dm-core-Don-t-include-ofnode-functions-with-of-platdata.diff
new file mode 100644
index 0000000000..7d13ffd210
--- /dev/null
+++ b/package/boot/uboot-rockchip/patches/U-Boot-v4-4-5-dm-core-Don-t-include-ofnode-functions-with-of-platdata.diff
@@ -0,0 +1,41 @@
+diff --git a/drivers/core/Makefile b/drivers/core/Makefile
+index bce7467da1..b9e4a2aab1 100644
+--- a/drivers/core/Makefile
++++ b/drivers/core/Makefile
+@@ -13,6 +13,8 @@ obj-$(CONFIG_OF_LIVE) += of_access.o of_addr.o
+ ifndef CONFIG_DM_DEV_READ_INLINE
+ obj-$(CONFIG_OF_CONTROL) += read.o
+ endif
+-obj-$(CONFIG_OF_CONTROL) += of_extra.o ofnode.o read_extra.o
++ifdef CONFIG_$(SPL_TPL_)OF_LIBFDT
++obj-$(CONFIG_$(SPL_TPL_)OF_CONTROL) += of_extra.o ofnode.o read_extra.o
++endif
+ 
+ ccflags-$(CONFIG_DM_DEBUG) += -DDEBUG
+diff --git a/include/dm/read.h b/include/dm/read.h
+index d37fcb504d..4f02d07d00 100644
+--- a/include/dm/read.h
++++ b/include/dm/read.h
+@@ -43,8 +43,7 @@ static inline bool dev_of_valid(struct udevice *dev)
+ 	return ofnode_valid(dev_ofnode(dev));
+ }
+ 
+-#ifndef CONFIG_DM_DEV_READ_INLINE
+-
++#if !defined(CONFIG_DM_DEV_READ_INLINE) || CONFIG_IS_ENABLED(OF_PLATDATA)
+ /**
+  * dev_read_u32() - read a 32-bit integer from a device's DT property
+  *
+diff --git a/net/eth-uclass.c b/net/eth-uclass.c
+index 3bd98b01ad..e3bfcdb6cc 100644
+--- a/net/eth-uclass.c
++++ b/net/eth-uclass.c
+@@ -462,7 +462,7 @@ static int eth_pre_unbind(struct udevice *dev)
+ 
+ static bool eth_dev_get_mac_address(struct udevice *dev, u8 mac[ARP_HLEN])
+ {
+-#if IS_ENABLED(CONFIG_OF_CONTROL)
++#if CONFIG_IS_ENABLED(OF_CONTROL)
+ 	const uint8_t *p;
+ 
+ 	p = dev_read_u8_array_ptr(dev, "mac-address", ARP_HLEN);
diff --git a/package/boot/uboot-rockchip/patches/U-Boot-v4-5-5-spl-Allow-SPL-TPL-to-use-of-platdata-without-libfdt.diff b/package/boot/uboot-rockchip/patches/U-Boot-v4-5-5-spl-Allow-SPL-TPL-to-use-of-platdata-without-libfdt.diff
new file mode 100644
index 0000000000..2455c18192
--- /dev/null
+++ b/package/boot/uboot-rockchip/patches/U-Boot-v4-5-5-spl-Allow-SPL-TPL-to-use-of-platdata-without-libfdt.diff
@@ -0,0 +1,22 @@
+diff --git a/lib/Kconfig b/lib/Kconfig
+index b8a8509d72..1cae2d5cc8 100644
+--- a/lib/Kconfig
++++ b/lib/Kconfig
+@@ -484,7 +484,7 @@ config OF_LIBFDT_OVERLAY
+ 
+ config SPL_OF_LIBFDT
+ 	bool "Enable the FDT library for SPL"
+-	default y if SPL_OF_CONTROL
++	default y if SPL_OF_CONTROL && !SPL_OF_PLATDATA
+ 	help
+ 	  This enables the FDT library (libfdt). It provides functions for
+ 	  accessing binary device tree images in memory, such as adding and
+@@ -505,7 +505,7 @@ config SPL_OF_LIBFDT_ASSUME_MASK
+ 
+ config TPL_OF_LIBFDT
+ 	bool "Enable the FDT library for TPL"
+-	default y if TPL_OF_CONTROL
++	default y if TPL_OF_CONTROL && !TPL_OF_PLATDATA
+ 	help
+ 	  This enables the FDT library (libfdt). It provides functions for
+ 	  accessing binary device tree images in memory, such as adding and
diff --git a/package/kernel/linux/modules/input.mk b/package/kernel/linux/modules/input.mk
index 0f6e4d507b..528d086082 100644
--- a/package/kernel/linux/modules/input.mk
+++ b/package/kernel/linux/modules/input.mk
@@ -193,6 +193,66 @@ endef
 $(eval $(call KernelPackage,input-touchscreen-ads7846))
 
 
+define KernelPackage/infrared-sensor
+  SUBMENU:=$(INPUT_MODULES_MENU)
+  TITLE:=infrared sensor support
+  DEPENDS:=+kmod-input-core
+  KCONFIG:= \
+	CONFIG_GPIOLIB=y \
+	CONFIG_SPI=y \
+	CONFIG_PWM=y \
+	CONFIG_LIRC=y \
+	CONFIG_IR_GPIO_CIR \
+	CONFIG_BPF_LIRC_MODE2 \
+	CONFIG_IR_SANYO_DECODER \
+	CONFIG_IR_SHARP_DECODER \
+	CONFIG_IR_MCE_KBD_DECODER \
+	CONFIG_IR_NEC_DECODER \
+	CONFIG_IR_XMP_DECODER \
+	CONFIG_IR_IMON_DECODER \
+	CONFIG_IR_RCMM_DECODER \
+	CONFIG_IR_IMON_RAW \
+	CONFIG_IR_SPI \
+	CONFIG_IR_GPIO_TX \
+	CONFIG_IR_PWM_TX \
+	CONFIG_IR_SERIAL \
+	CONFIG_IR_SERIAL_TRANSMITTER=y \
+	CONFIG_IR_SIR \
+	CONFIG_RC_CORE \
+	CONFIG_RC_MAP \
+	CONFIG_RC_DECODERS=y \
+	CONFIG_RC_DEVICES=y \
+	CONFIG_RC_XBOX_DVD
+  FILES:= \
+	$(LINUX_DIR)/drivers/media/rc/gpio-ir-recv.ko \
+	$(LINUX_DIR)/drivers/media/rc/gpio-ir-tx.ko \
+	$(LINUX_DIR)/drivers/media/rc/imon_raw.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-imon-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-mce_kbd-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-nec-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-rcmm-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-sanyo-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-sharp-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-spi.ko \
+	$(LINUX_DIR)/drivers/media/rc/ir-xmp-decoder.ko \
+	$(LINUX_DIR)/drivers/media/rc/pwm-ir-tx.ko \
+	$(LINUX_DIR)/drivers/media/rc/rc-core.ko \
+	$(LINUX_DIR)/drivers/media/rc/serial_ir.ko \
+	$(LINUX_DIR)/drivers/media/rc/sir_ir.ko \
+	$(LINUX_DIR)/drivers/media/rc/xbox_remote.ko
+
+  AUTOLOAD:=$(call AutoProbe,rc-core gpio-ir-recv gpio-ir-tx imon_raw ir-imon-decoder \
+	ir-mce_kbd-decoder ir-nec-decoder ir-rcmm-decoder ir-sanyo-decoder \
+	ir-sharp-decoder ir-spi ir-xmp-decoder pwm-ir-tx sir_ir xbox_remote)
+endef
+
+define KernelPackage/infrared-sensor/description
+ Enable support for infrared sensors.
+endef
+
+$(eval $(call KernelPackage,infrared-sensor))
+
+
 define KernelPackage/keyboard-imx
   SUBMENU:=$(INPUT_MODULES_MENU)
   TITLE:=IMX keypad support
@@ -210,7 +270,6 @@ endef
 
 $(eval $(call KernelPackage,keyboard-imx))
 
-
 define KernelPackage/input-uinput
   SUBMENU:=$(INPUT_MODULES_MENU)
   TITLE:=user input module
diff --git a/package/kernel/linux/modules/sound.mk b/package/kernel/linux/modules/sound.mk
index f975103e50..b9ddf235f4 100644
--- a/package/kernel/linux/modules/sound.mk
+++ b/package/kernel/linux/modules/sound.mk
@@ -518,3 +518,39 @@ define KernelPackage/sound-hda-intel/description
 endef
 
 $(eval $(call KernelPackage,sound-hda-intel))
+
+define KernelPackage/sound-soc-rockchip
+  TITLE:=Rockchip SoC support
+  KCONFIG:=\
+	CONFIG_SOUND=y \
+	CONFIG_SND=y \
+	CONFIG_SND_SIMPLE_CARD \
+	CONFIG_SND_SOC_DMAENGINE_PCM \
+	CONFIG_SND_SOC_RK3328 \
+	CONFIG_SND_SOC_ROCKCHIP \
+	CONFIG_SND_SOC_ROCKCHIP_I2S \
+	CONFIG_SND_SOC_ROCKCHIP_I2S_TDM \
+	CONFIG_SND_SOC_ROCKCHIP_PDM \
+	CONFIG_SND_SOC_SPDIF \
+	CONFIG_SND_SOC_ROCKCHIP_SPDIF
+  FILES:= \
+	$(LINUX_DIR)/sound/soc/rockchip/snd-soc-rockchip-pcm.ko \
+	$(LINUX_DIR)/sound/soc/rockchip/snd-soc-rockchip-pdm.ko \
+	$(LINUX_DIR)/sound/soc/rockchip/snd-soc-rockchip-i2s.ko \
+	$(LINUX_DIR)/sound/soc/rockchip/snd-soc-rockchip-spdif.ko \
+	$(LINUX_DIR)/sound/soc/generic/snd-soc-simple-card.ko \
+	$(LINUX_DIR)/sound/soc/generic/snd-soc-simple-card-utils.ko \
+	$(LINUX_DIR)/sound/soc/codecs/snd-soc-rk3328.ko \
+	$(LINUX_DIR)/sound/soc/codecs/snd-soc-spdif-tx.ko \
+	$(LINUX_DIR)/sound/soc/codecs/snd-soc-spdif-rx.ko
+  AUTOLOAD:=$(call AutoProbe,snd-soc-rk3328 snd-soc-rockchip-i2s snd-soc-rockchip-pdm \
+	snd-soc-spdif-tx snd-soc-rockchip-spdif snd-soc-simple-card)
+  DEPENDS:=@TARGET_rockchip +kmod-sound-soc-core
+  $(call AddDepends/sound)
+endef
+
+define KernelPackage/sound-soc-rockchip/description
+ Support for Rockchip Platform sound (pdm/pcm/spdif)
+endef
+
+$(eval $(call KernelPackage,sound-soc-rockchip))
diff --git a/package/kernel/linux/modules/video.mk b/package/kernel/linux/modules/video.mk
index c17aed7613..64c938428d 100644
--- a/package/kernel/linux/modules/video.mk
+++ b/package/kernel/linux/modules/video.mk
@@ -387,6 +387,85 @@ endef
 
 $(eval $(call KernelPackage,drm-radeon))
 
+define KernelPackage/gpu-lima
+  SUBMENU:=$(VIDEO_MENU)
+  TITLE:=Mali-4xx GPU support
+  DEPENDS:=+kmod-drm
+  KCONFIG:= \
+	CONFIG_DRM_VGEM \
+	CONFIG_DRM_GEM_CMA_HELPER=y \
+	CONFIG_DRM_LIMA
+  FILES:= \
+	$(LINUX_DIR)/drivers/gpu/drm/vgem/vgem.ko \
+	$(LINUX_DIR)/drivers/gpu/drm/scheduler/gpu-sched.ko \
+	$(LINUX_DIR)/drivers/gpu/drm/lima/lima.ko
+  AUTOLOAD:=$(call AutoProbe,lima vgem)
+endef
+
+define KernelPackage/gpu-lima/description
+  Open-source reverse-engineered driver for Mali-4xx GPUs
+endef
+
+$(eval $(call KernelPackage,gpu-lima))
+
+define KernelPackage/drm-rockchip
+  SUBMENU:=$(VIDEO_MENU)
+  TITLE:=Rockchip DRM support
+  DEPENDS:=@TARGET_rockchip +kmod-backlight +kmod-drm-kms-helper
+  KCONFIG:=CONFIG_DRM_ROCKCHIP \
+	CONFIG_DRM_LOAD_EDID_FIRMWARE=y \
+	CONFIG_DRM_FBDEV_EMULATION=y \
+	CONFIG_DRM_FBDEV_OVERALLOC=100 \
+	CONFIG_DRM_BRIDGE \
+	CONFIG_HDMI \
+	CONFIG_PHY_ROCKCHIP_INNO_HDMI \
+	CONFIG_DRM_DW_HDMI \
+	CONFIG_DRM_DW_HDMI_CEC \
+	CONFIG_ROCKCHIP_DW_HDMI=y \
+	CONFIG_ROCKCHIP_INNO_HDMI=y \
+	CONFIG_ROCKCHIP_DW_MIPI_DSI=y \
+	CONFIG_ROCKCHIP_LVDS=y \
+	CONFIG_DRM_PANEL \
+	CONFIG_DRM_PANEL_BRIDGE \
+	CONFIG_DRM_PANEL_SIMPLE
+  FILES:= \
+	$(LINUX_DIR)/drivers/gpu/drm/bridge/synopsys/dw-hdmi.ko \
+	$(LINUX_DIR)/drivers/gpu/drm/bridge/synopsys/dw-hdmi-cec.ko \
+	$(LINUX_DIR)/drivers/gpu/drm/bridge/synopsys/dw-mipi-dsi.ko \
+	$(LINUX_DIR)/drivers/media/cec/cec.ko \
+	$(LINUX_DIR)/drivers/phy/rockchip/phy-rockchip-inno-hdmi.ko \
+	$(LINUX_DIR)/drivers/gpu/drm/panel/panel-simple.ko \
+	$(LINUX_DIR)/drivers/gpu/drm/rockchip/rockchipdrm.ko
+  AUTOLOAD:=$(call AutoProbe,rockchipdrm phy-rockchip-inno-hdmi dw-hdmi-cec)
+endef
+
+define KernelPackage/drm-rockchip/description
+  Direct Rendering Manager (DRM) support for Rockchip
+endef
+
+$(eval $(call KernelPackage,drm-rockchip))
+
+define KernelPackage/drm-rockchip-hdmi-sound
+  SUBMENU:=$(VIDEO_MENU)
+  TITLE:=Rockchip HDMI Sound support
+  DEPENDS:=@TARGET_rockchip +kmod-sound-soc-rockchip +kmod-drm-rockchip
+  KCONFIG:= \
+	CONFIG_SND_AUDIO_GRAPH_CARD \
+	CONFIG_SND_SOC_HDMI_CODEC \
+	CONFIG_DRM_DW_HDMI_I2S_AUDIO
+  FILES:= \
+	$(LINUX_DIR)/drivers/gpu/drm/bridge/synopsys/dw-hdmi-i2s-audio.ko \
+	$(LINUX_DIR)/sound/soc/generic/snd-soc-audio-graph-card.ko \
+	$(LINUX_DIR)/sound/soc/codecs/snd-soc-hdmi-codec.ko
+  AUTOLOAD:=$(call AutoProbe,dw-hdmi-i2s-audio snd-soc-hdmi-codec snd-soc-audio-graph-card)
+endef
+
+define KernelPackage/drm-rockchip-hdmi-sound/description
+  Open-source reverse-engineered driver for Mali-4xx GPUs
+endef
+
+$(eval $(call KernelPackage,drm-rockchip-hdmi-sound))
+
 #
 # Video Capture
 #
diff --git a/target/linux/generic/config-5.4 b/target/linux/generic/config-5.4
index 21dd447cdf..9803076def 100644
--- a/target/linux/generic/config-5.4
+++ b/target/linux/generic/config-5.4
@@ -1345,10 +1345,12 @@ CONFIG_DQL=y
 # CONFIG_DRM_NXP_PTN3460 is not set
 # CONFIG_DRM_OMAP is not set
 # CONFIG_DRM_PANEL_ARM_VERSATILE is not set
+# CONFIG_DRM_PANEL_FEIYANG_FY07024DI26A30D is not set
 # CONFIG_DRM_PANEL_ILITEK_IL9322 is not set
 # CONFIG_DRM_PANEL_ILITEK_ILI9881C is not set
 # CONFIG_DRM_PANEL_INNOLUX_P079ZCA is not set
 # CONFIG_DRM_PANEL_JDI_LT070ME05000 is not set
+# CONFIG_DRM_PANEL_KINGDISPLAY_KD097D04 is not set
 # CONFIG_DRM_PANEL_LG_LB035Q02 is not set
 # CONFIG_DRM_PANEL_LG_LG4573 is not set
 # CONFIG_DRM_PANEL_LVDS is not set
@@ -1356,10 +1358,15 @@ CONFIG_DQL=y
 # CONFIG_DRM_PANEL_NOVATEK_NT39016 is not set
 # CONFIG_DRM_PANEL_OLIMEX_LCD_OLINUXINO is not set
 # CONFIG_DRM_PANEL_ORISETECH_OTM8009A is not set
+# CONFIG_DRM_PANEL_OSD_OSD101T2587_53TS is not set
 # CONFIG_DRM_PANEL_PANASONIC_VVX10F034N00 is not set
 # CONFIG_DRM_PANEL_RASPBERRYPI_TOUCHSCREEN is not set
+# CONFIG_DRM_PANEL_RAYDIUM_RM67191 is not set
 # CONFIG_DRM_PANEL_RAYDIUM_RM68200 is not set
+# CONFIG_DRM_PANEL_ROCKTECH_JH057N00900 is not set
+# CONFIG_DRM_PANEL_RONBO_RB070D30 is not set
 # CONFIG_DRM_PANEL_SAMSUNG_LD9040 is not set
+# CONFIG_DRM_PANEL_SAMSUNG_S6D16D0 is not set
 # CONFIG_DRM_PANEL_SAMSUNG_S6E3HA2 is not set
 # CONFIG_DRM_PANEL_SAMSUNG_S6E63J0X03 is not set
 # CONFIG_DRM_PANEL_SAMSUNG_S6E63M0 is not set
@@ -1368,11 +1375,13 @@ CONFIG_DQL=y
 # CONFIG_DRM_PANEL_SHARP_LQ101R1SX01 is not set
 # CONFIG_DRM_PANEL_SHARP_LS037V7DW01 is not set
 # CONFIG_DRM_PANEL_SHARP_LS043T1LE01 is not set
+# CONFIG_DRM_PANEL_SITRONIX_ST7701 is not set
 # CONFIG_DRM_PANEL_SITRONIX_ST7789V is not set
 # CONFIG_DRM_PANEL_SONY_ACX565AKM is not set
 # CONFIG_DRM_PANEL_TPO_TD043MTEA1 is not set
 # CONFIG_DRM_PANEL_TPO_TD028TTEC1 is not set
 # CONFIG_DRM_PANEL_TPO_TPG110 is not set
+# CONFIG_DRM_PANEL_TRULY_NT35597_WQXGA is not set
 # CONFIG_DRM_PANFROST is not set
 # CONFIG_DRM_PARADE_PS8622 is not set
 # CONFIG_DRM_PL111 is not set
diff --git a/target/linux/rockchip/armv8/base-files/etc/inittab b/target/linux/rockchip/armv8/base-files/etc/inittab
new file mode 100644
index 0000000000..df47827128
--- /dev/null
+++ b/target/linux/rockchip/armv8/base-files/etc/inittab
@@ -0,0 +1,6 @@
+::sysinit:/etc/init.d/rcS S boot
+::shutdown:/etc/init.d/rcS K shutdown
+::askconsole:/usr/libexec/login.sh
+tts/0::askfirst:/usr/libexec/login.sh
+ttyS0::askfirst:/usr/libexec/login.sh
+tty1::askfirst:/usr/libexec/login.sh
diff --git a/target/linux/rockchip/armv8/config-5.4 b/target/linux/rockchip/armv8/config-5.4
index 48b05b432b..43cbe48087 100644
--- a/target/linux/rockchip/armv8/config-5.4
+++ b/target/linux/rockchip/armv8/config-5.4
@@ -73,7 +73,7 @@ CONFIG_CMA_ALIGNMENT=8
 CONFIG_CMA_AREAS=7
 # CONFIG_CMA_DEBUG is not set
 # CONFIG_CMA_DEBUGFS is not set
-CONFIG_CMA_SIZE_MBYTES=5
+CONFIG_CMA_SIZE_MBYTES=16
 # CONFIG_CMA_SIZE_SEL_MAX is not set
 CONFIG_CMA_SIZE_SEL_MBYTES=y
 # CONFIG_CMA_SIZE_SEL_MIN is not set
@@ -101,12 +101,14 @@ CONFIG_CPU_FREQ_GOV_POWERSAVE=y
 CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
 # CONFIG_CPU_FREQ_GOV_USERSPACE is not set
 CONFIG_CPU_FREQ_STAT=y
+CONFIG_CPU_HAS_PMU=y
 CONFIG_CPU_IDLE=y
 # CONFIG_CPU_IDLE_GOV_LADDER is not set
 CONFIG_CPU_IDLE_GOV_MENU=y
 CONFIG_CPU_IDLE_MULTIPLE_DRIVERS=y
 CONFIG_CPU_ISOLATION=y
 CONFIG_CPU_PM=y
+CONFIG_CPU_SH4A=y
 CONFIG_CPU_THERMAL=y
 CONFIG_CRASH_CORE=y
 CONFIG_CRASH_DUMP=y
@@ -134,6 +136,10 @@ CONFIG_DMA_ENGINE=y
 CONFIG_DMA_OF=y
 CONFIG_DMA_SHARED_BUFFER=y
 CONFIG_DNOTIFY=y
+CONFIG_DRM=y
+# CONFIG_DRM_ROCKCHIP is not set
+# CONFIG_ROCKCHIP_ANALOGIX_DP is not set
+# CONFIG_ROCKCHIP_CDN_DP is not set
 CONFIG_DT_IDLE_STATES=y
 CONFIG_DUMMY_CONSOLE=y
 CONFIG_DWMAC_DWC_QOS_ETH=y
@@ -146,6 +152,7 @@ CONFIG_EXT4_FS=y
 CONFIG_EXT4_FS_POSIX_ACL=y
 CONFIG_EXTCON=y
 CONFIG_FANOTIFY=y
+CONFIG_FB=y
 CONFIG_FHANDLE=y
 CONFIG_FIXED_PHY=y
 # CONFIG_FLATMEM_MANUAL is not set
@@ -163,6 +170,9 @@ CONFIG_GPIOLIB=y
 CONFIG_GPIO_DWAPB=y
 CONFIG_GPIO_GENERIC=y
 CONFIG_GPIO_GENERIC_PLATFORM=y
+CONFIG_GPIO_RK8XX=y
+CONFIG_GPIO_SYSCON=y
+CONFIG_GPIO_SYSFS=y
 # CONFIG_HARDENED_USERCOPY is not set
 CONFIG_HAS_IOPORT_MAP=y
 CONFIG_HAVE_ARCH_MMAP_RND_COMPAT_BITS=y
@@ -182,15 +192,23 @@ CONFIG_HUGETLB_PAGE=y
 CONFIG_HWMON=y
 CONFIG_HWSPINLOCK=y
 CONFIG_HW_CONSOLE=y
+CONFIG_HW_PERF_EVENTS=y
 # CONFIG_HZ_PERIODIC is not set
 CONFIG_I2C=y
 CONFIG_I2C_ALGOBIT=y
 CONFIG_I2C_BOARDINFO=y
 CONFIG_I2C_CHARDEV=y
 CONFIG_I2C_COMPAT=y
+CONFIG_I2C_DESIGNWARE_CORE=y
+CONFIG_I2C_DESIGNWARE_PLATFORM=y
+# CONFIG_I2C_DESIGNWARE_SLAVE is not set
 CONFIG_I2C_GPIO=y
 CONFIG_I2C_HELPER_AUTO=y
+CONFIG_I2C_MUX=y
+CONFIG_I2C_MUX_PCA954x=y
 CONFIG_I2C_RK3X=y
+CONFIG_I2C_SLAVE=y
+# CONFIG_I2C_SLAVE_EEPROM is not set
 CONFIG_INDIRECT_PIO=y
 CONFIG_INPUT=y
 CONFIG_INPUT_EVDEV=y
@@ -198,7 +216,9 @@ CONFIG_INPUT_FF_MEMLESS=y
 CONFIG_INPUT_KEYBOARD=y
 CONFIG_INPUT_LEDS=y
 CONFIG_INPUT_MATRIXKMAP=y
-# CONFIG_INPUT_MISC is not set
+CONFIG_INPUT_MISC=y
+CONFIG_INPUT_RAVE_SP_PWRBUTTON=y
+CONFIG_INPUT_RK805_PWRKEY=y
 CONFIG_IOMMU_API=y
 # CONFIG_IOMMU_DEBUGFS is not set
 # CONFIG_IOMMU_DEFAULT_PASSTHROUGH is not set
@@ -212,6 +232,7 @@ CONFIG_IOMMU_SUPPORT=y
 # CONFIG_IONIC is not set
 # CONFIG_IO_STRICT_DEVMEM is not set
 CONFIG_IO_URING=y
+# CONFIG_IPMB_DEVICE_INTERFACE is not set
 CONFIG_IRQ_MSI_IOMMU=y
 CONFIG_IRQ_TIME_ACCOUNTING=y
 CONFIG_JBD2=y
@@ -223,11 +244,13 @@ CONFIG_KEXEC_FILE=y
 # CONFIG_KEXEC_SIG is not set
 CONFIG_KEYBOARD_GPIO=y
 CONFIG_KSM=y
+CONFIG_KVM=y
 # CONFIG_LEDS_BRIGHTNESS_HW_CHANGED is not set
 CONFIG_LEDS_GPIO=y
 CONFIG_LEDS_PWM=y
 CONFIG_LEDS_SYSCON=y
 CONFIG_LEDS_TRIGGER_CPU=y
+CONFIG_LEDS_TRIGGER_GPIO=y
 CONFIG_LEDS_TRIGGER_HEARTBEAT=y
 CONFIG_LEDS_TRIGGER_PANIC=y
 # CONFIG_LEDS_TRIGGER_TIMER is not set
@@ -248,6 +271,7 @@ CONFIG_MDIO_BUS_MUX_GPIO=y
 CONFIG_MDIO_BUS_MUX_MMIOREG=y
 CONFIG_MDIO_DEVICE=y
 CONFIG_MDIO_GPIO=y
+CONFIG_MEDIA_CEC_RC=y
 CONFIG_MEMORY_ISOLATION=y
 CONFIG_MFD_CORE=y
 CONFIG_MFD_RK808=y
@@ -318,18 +342,23 @@ CONFIG_PCI_DOMAINS_GENERIC=y
 CONFIG_PCI_MSI=y
 CONFIG_PCI_MSI_IRQ_DOMAIN=y
 CONFIG_PCI_STUB=y
+CONFIG_PERF_EVENTS=y
 CONFIG_PGTABLE_LEVELS=4
 CONFIG_PHYLIB=y
 CONFIG_PHYLINK=y
-CONFIG_PHY_ROCKCHIP_DP=y
+# CONFIG_PHY_ROCKCHIP_DP is not set
 CONFIG_PHY_ROCKCHIP_EMMC=y
 # CONFIG_PHY_ROCKCHIP_INNO_HDMI is not set
 CONFIG_PHY_ROCKCHIP_INNO_USB2=y
+CONFIG_PHY_ROCKCHIP_INNO_USB3=y
+# CONFIG_ROCKCHIP_LVDS is not set
+# CONFIG_ROCKCHIP_RGB is not set
+# CONFIG_ROCKCHIP_RK3066_HDMI is not set
 CONFIG_PHY_ROCKCHIP_PCIE=y
 CONFIG_PHY_ROCKCHIP_TYPEC=y
 CONFIG_PHY_ROCKCHIP_USB=y
 CONFIG_PINCTRL=y
-# CONFIG_PINCTRL_RK805 is not set
+CONFIG_PINCTRL_RK805=y
 CONFIG_PINCTRL_ROCKCHIP=y
 # CONFIG_PINCTRL_SINGLE is not set
 CONFIG_PL330_DMA=y
@@ -343,6 +372,9 @@ CONFIG_PM_GENERIC_DOMAINS_OF=y
 CONFIG_PM_OPP=y
 CONFIG_POWER_AVS=y
 CONFIG_POWER_SUPPLY_HWMON=y
+CONFIG_PPS=y
+CONFIG_PPS_CLIENT_KTIMER=y
+CONFIG_PPS_CLIENT_GPIO=y
 CONFIG_PREEMPT=y
 CONFIG_PREEMPTION=y
 CONFIG_PREEMPT_COUNT=y
@@ -370,6 +402,7 @@ CONFIG_RCU_CPU_STALL_TIMEOUT=21
 # CONFIG_RCU_EXPERT is not set
 CONFIG_RCU_TRACE=y
 # CONFIG_READ_ONLY_THP_FOR_FS is not set
+CONFIG_REALTEK_PHY=y
 CONFIG_REGMAP=y
 CONFIG_REGMAP_I2C=y
 CONFIG_REGMAP_IRQ=y
@@ -381,14 +414,18 @@ CONFIG_REGULATOR_PWM=y
 CONFIG_REGULATOR_RK808=y
 CONFIG_RELOCATABLE=y
 CONFIG_RESET_CONTROLLER=y
+#CONFIG_RK_VCODEC=y
 CONFIG_ROCKCHIP_EFUSE=y
 CONFIG_ROCKCHIP_GRF=y
 CONFIG_ROCKCHIP_IODOMAIN=y
 CONFIG_ROCKCHIP_IOMMU=y
 CONFIG_ROCKCHIP_MBOX=y
+#CONFIG_ROCKCHIP_MPP_SERVICE=y
+#CONFIG_ROCKCHIP_MPP_DEVICE=y
 CONFIG_ROCKCHIP_PHY=y
 CONFIG_ROCKCHIP_PM_DOMAINS=y
-# CONFIG_ROCKCHIP_THERMAL is not set
+CONFIG_ROCKCHIP_SARADC=y
+CONFIG_ROCKCHIP_THERMAL=y
 CONFIG_ROCKCHIP_TIMER=y
 CONFIG_RSEQ=y
 CONFIG_RTC_CLASS=y
@@ -426,6 +463,11 @@ CONFIG_SERIO_LIBPS2=y
 CONFIG_SG_POOL=y
 CONFIG_SIMPLE_PM_BUS=y
 CONFIG_SLUB_DEBUG=y
+# CONFIG_SND_SOC_RK3288_HDMI_ANALOG is not set
+# CONFIG_SND_SOC_ROCKCHIP_MAX98090 is not set
+# CONFIG_SND_SOC_ROCKCHIP_RT5645 is not set
+# CONFIG_SND_SOC_ROCKCHIP_RT5651 is not set
+# CONFIG_SND_SOC_RK3399_GRU_SOUND is not set
 CONFIG_SPARSEMEM=y
 CONFIG_SPARSEMEM_EXTREME=y
 CONFIG_SPARSEMEM_MANUAL=y
@@ -444,7 +486,7 @@ CONFIG_SQUASHFS_FILE_CACHE=y
 CONFIG_SRAM=y
 CONFIG_STACKPROTECTOR=y
 CONFIG_STACKPROTECTOR_STRONG=y
-# CONFIG_STAGING is not set
+CONFIG_STAGING=y
 CONFIG_STMMAC_ETH=y
 CONFIG_STMMAC_PLATFORM=y
 # CONFIG_STMMAC_SELFTESTS is not set
@@ -483,7 +525,10 @@ CONFIG_TYPEC_TCPM=y
 CONFIG_UNINLINE_SPIN_UNLOCK=y
 CONFIG_USB=y
 CONFIG_USB_COMMON=y
+CONFIG_USB_DWC2=y
+CONFIG_USB_DWC2_DUAL_ROLE=y
 CONFIG_USB_DWC3=y
+CONFIG_USB_DWC3_DUAL_ROLE=y
 CONFIG_USB_DWC3_HOST=y
 CONFIG_USB_DWC3_OF_SIMPLE=y
 CONFIG_USB_EHCI_HCD=y
@@ -502,8 +547,14 @@ CONFIG_USB_ULPI_VIEWPORT=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_PLATFORM=y
 # CONFIG_USERIO is not set
+CONFIG_VIDEO_IR_I2C=y
 # CONFIG_VFIO is not set
+# CONFIG_VFIO_NOIOMMU is not set
+# CONFIG_VFIO_PCI is not set
+# CONFIG_VFIO_PLATFORM is not set
+# CONFIG_VFIO_MDEV is not set
 # CONFIG_VIRTIO_MENU is not set
+CONFIG_VIRTUALIZATION=y
 CONFIG_VM_EVENT_COUNTERS=y
 CONFIG_VT=y
 CONFIG_VT_CONSOLE=y
@@ -516,3 +567,8 @@ CONFIG_XZ_DEC_ARMTHUMB=y
 CONFIG_XZ_DEC_BCJ=y
 CONFIG_ZLIB_DEFLATE=y
 CONFIG_ZLIB_INFLATE=y
+CONFIG_MEDIA_SUPPORT=y
+CONFIG_VIDEOBUF2_DMA_CONTIG=y
+CONFIG_V4L2_MEM2MEM_DEV=y
+# CONFIG_ROCKCHIP_MPP_VDEC_DEVICE is not set
+# CONFIG_ROCKCHIP_MPP_VDPU2_DEVICE is not set
diff --git a/target/linux/rockchip/image/Makefile b/target/linux/rockchip/image/Makefile
index 5f605ebfe5..da819e4bc7 100644
--- a/target/linux/rockchip/image/Makefile
+++ b/target/linux/rockchip/image/Makefile
@@ -24,7 +24,7 @@ endef
 
 define Build/boot-script
 	# Make an U-boot image and copy it to the boot partition
-	mkimage -A arm -O linux -T script -C none -a 0 -e 0 -d mmc.bootscript $@.boot/boot.scr
+	mkimage -A arm -O linux -T script -C lzma -a 0 -e 0 -d mmc.bootscript $@.boot/boot.scr
 endef
 
 define Build/pine64-img
@@ -50,7 +50,7 @@ endef
 ### Devices ###
 define Device/Default
   PROFILES := Default
-  KERNEL := kernel-bin
+  KERNEL := kernel-bin | lzma
   IMAGES := sysupgrade.img.gz
   SUPPORTED_DEVICES := $(subst _,$(comma),$(1))
   DEVICE_DTS = rockchip/$$(SOC)-$(lastword $(subst _, ,$(1)))
diff --git a/target/linux/rockchip/image/armv8.mk b/target/linux/rockchip/image/armv8.mk
index 737c6e4f9a..e018f1c647 100644
--- a/target/linux/rockchip/image/armv8.mk
+++ b/target/linux/rockchip/image/armv8.mk
@@ -4,6 +4,16 @@
 # This is free software, licensed under the GNU General Public License v2.
 # See /LICENSE for more information.
 #
+
+define Device/pine64_rock64
+  DEVICE_VENDOR := Pine64
+  DEVICE_MODEL := Rock64
+  SOC := rk3328
+  UBOOT_DEVICE_NAME := rock64-rk3328
+  IMAGE/sysupgrade.img.gz := boot-common | boot-script | pine64-img | gzip | append-metadata
+endef
+TARGET_DEVICES += pine64_rock64
+
 define Device/pine64_rockpro64
   DEVICE_VENDOR := Pine64
   DEVICE_MODEL := RockPro64
diff --git a/target/linux/rockchip/image/mmc.bootscript b/target/linux/rockchip/image/mmc.bootscript
index b70a62c4c7..13a55d3ac9 100644
--- a/target/linux/rockchip/image/mmc.bootscript
+++ b/target/linux/rockchip/image/mmc.bootscript
@@ -1,8 +1,18 @@
 part uuid mmc ${devnum}:2 uuid
 
-setenv bootargs "console=ttyS2,1500000 console=tty1 earlycon=uart8250,mmio32,0xff1a0000 root=PARTUUID=${uuid} rw rootwait"
+if test $stdout = 'serial@ff1a0000' ;
+then serial_addr=',0xff1a0000';
+elif test $stdout = 'serial@ff130000' ;
+then serial_addr=',0xff130000';
+fi;
+
+setenv bootargs "console=ttyS2,1500000 console=tty1 earlycon=uart8250,mmio32${serial_addr} swiotlb=1 root=PARTUUID=${uuid} rw rootwait loglevel=9";
 
 load mmc ${devnum}:1 ${fdt_addr_r} rockchip.dtb
 load mmc ${devnum}:1 ${kernel_addr_r} kernel.img
 
-booti ${kernel_addr_r} - ${fdt_addr_r}
+echo "Uncompress lzma kernel into memmory.."
+setexpr kernel_addr_dec ${filesize} + ${kernel_addr_r} || kernel_addr_dec=0x03000000
+lzmadec ${kernel_addr_r} ${kernel_addr_dec}
+
+booti ${kernel_addr_dec} - ${fdt_addr_r}
diff --git a/target/linux/rockchip/patches-5.4/0001-add_sound_rk3328_rock64.patch b/target/linux/rockchip/patches-5.4/0001-add_sound_rk3328_rock64.patch
new file mode 100644
index 0000000000..fb385e5b18
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0001-add_sound_rk3328_rock64.patch
@@ -0,0 +1,170 @@
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -142,6 +159,22 @@
+ 		};
+ 	};
+ 
++	analog_sound: analog-sound {
++		compatible = "simple-audio-card";
++		simple-audio-card,format = "i2s";
++		simple-audio-card,mclk-fs = <256>;
++		simple-audio-card,name = "Analog";
++		status = "disabled";
++
++		simple-audio-card,cpu {
++			sound-dai = <&i2s1>;
++		};
++
++		simple-audio-card,codec {
++			sound-dai = <&codec>;
++		};
++	};
++
+ 	arm-pmu {
+ 		compatible = "arm,cortex-a53-pmu";
+ 		interrupts = <GIC_SPI 100 IRQ_TYPE_LEVEL_HIGH>,
+@@ -156,11 +189,47 @@
+ 		ports = <&vop_out>;
+ 	};
+ 
++	hdmi_sound: hdmi-sound {
++		compatible = "simple-audio-card";
++		simple-audio-card,format = "i2s";
++		simple-audio-card,mclk-fs = <128>;
++		simple-audio-card,name = "HDMI";
++		status = "disabled";
++
++		simple-audio-card,cpu {
++			sound-dai = <&i2s0>;
++		};
++
++		simple-audio-card,codec {
++			sound-dai = <&hdmi>;
++		};
++	};
++
+ 	psci {
+ 		compatible = "arm,psci-1.0", "arm,psci-0.2";
+ 		method = "smc";
+ 	};
+ 
++	spdif_out: spdif-out {
++		compatible = "linux,spdif-dit";
++		#sound-dai-cells = <0>;
++		status = "disabled";
++	};
++
++	spdif_sound: spdif-sound {
++		compatible = "simple-audio-card";
++		simple-audio-card,name = "SPDIF";
++		status = "disabled";
++
++		simple-audio-card,cpu {
++			sound-dai = <&spdif>;
++		};
++
++		simple-audio-card,codec {
++			sound-dai = <&spdif_out>;
++		};
++	};
++
+ 	timer {
+ 		compatible = "arm,armv8-timer";
+ 		interrupts = <GIC_PPI 13 (GIC_CPU_MASK_SIMPLE(4) | IRQ_TYPE_LEVEL_LOW)>,
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -83,34 +70,14 @@
+ 			linux,default-trigger = "heartbeat";
+ 		};
+ 	};
++};
+ 
+-	sound {
+-		compatible = "audio-graph-card";
+-		label = "rockchip,rk3328";
+-		dais = <&i2s1_p0
+-			&spdif_p0>;
+-	};
+-
+-	spdif-dit {
+-		compatible = "linux,spdif-dit";
+-		#sound-dai-cells = <0>;
+-
+-		port {
+-			dit_p0_0: endpoint {
+-				remote-endpoint = <&spdif_p0_0>;
+-			};
+-		};
+-	};
++&analog_sound {
++	status = "okay";
+ };
+ 
+ &codec {
+ 	status = "okay";
+-
+-	port@0 {
+-		codec_p0_0: endpoint {
+-			remote-endpoint = <&i2s1_p0_0>;
+-		};
+-	};
+ };
+ 
+ &cpu0 {
+@@ -166,6 +140,10 @@
+ 	status = "okay";
+ };
+ 
++&hdmi_sound {
++	status = "okay";
++};
++
+ &i2c1 {
+ 	status = "okay";
+ 
+@@ -277,21 +255,15 @@
+ 	};
+ };
+ 
+-&i2s1 {
++&i2s0 {
+ 	status = "okay";
+-
+-	i2s1_p0: port {
+-		i2s1_p0_0: endpoint {
+-			dai-format = "i2s";
+-			mclk-fs = <256>;
+-			remote-endpoint = <&codec_p0_0>;
+-		};
+-	};
+ };
+ 
+-&io_domains {
++&i2s1 {
+ 	status = "okay";
++};
+ 
++&io_domains {
+ 	vccio1-supply = <&vcc_io>;
+ 	vccio2-supply = <&vcc18_emmc>;
+ 	vccio3-supply = <&vcc_io>;
+@@ -336,12 +308,14 @@
+ &spdif {
+ 	pinctrl-0 = <&spdifm0_tx>;
+ 	status = "okay";
++};
+ 
+-	spdif_p0: port {
+-		spdif_p0_0: endpoint {
+-			remote-endpoint = <&dit_p0_0>;
+-		};
+-	};
++&spdif_out {
++	status = "okay";
++};
++
++&spdif_sound {
++	status = "okay";
+ };
+ 
+ &spi0 {
diff --git a/target/linux/rockchip/patches-5.4/0002-rock64_fixed_regulator_gpio_warning.patch b/target/linux/rockchip/patches-5.4/0002-rock64_fixed_regulator_gpio_warning.patch
new file mode 100644
index 0000000000..95b806da50
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0002-rock64_fixed_regulator_gpio_warning.patch
@@ -0,0 +1,41 @@
+From 2bc8ee6ca6ba413a4952c2d54c479a0ddd83ba99 Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 21 Apr 2019 18:07:33 +0000
+Subject: [PATCH] arm64: dts: rockchip: fix fixed-regulator gpio warning on
+ rk3328
+
+---
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 6 +++---
+ 1 files changed, 3 insertions(+), 3 deletions(-)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index 1af6c56a4451..7cca8808257e 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -23,7 +23,7 @@
+ 
+ 	vcc_sd: sdmmc-regulator {
+ 		compatible = "regulator-fixed";
+-		gpio = <&gpio0 RK_PD6 GPIO_ACTIVE_LOW>;
++		gpio = <&gpio0 RK_PD6 GPIO_ACTIVE_HIGH>;
+ 		pinctrl-names = "default";
+ 		pinctrl-0 = <&sdmmc0m1_gpio>;
+ 		regulator-name = "vcc_sd";
+@@ -34,7 +34,7 @@
+ 
+ 	vcc_host_5v: vcc-host-5v-regulator {
+ 		compatible = "regulator-fixed";
+-		gpio = <&gpio0 RK_PA2 GPIO_ACTIVE_LOW>;
++		gpio = <&gpio0 RK_PA2 GPIO_ACTIVE_HIGH>;
+ 		pinctrl-names = "default";
+ 		pinctrl-0 = <&usb20_host_drv>;
+ 		regulator-name = "vcc_host_5v";
+@@ -45,7 +45,7 @@
+ 
+ 	vcc_host1_5v: vcc_otg_5v: vcc-host1-5v-regulator {
+ 		compatible = "regulator-fixed";
+-		gpio = <&gpio0 RK_PA2 GPIO_ACTIVE_LOW>;
++		gpio = <&gpio0 RK_PA2 GPIO_ACTIVE_HIGH>;
+ 		pinctrl-names = "default";
+ 		pinctrl-0 = <&usb20_host_drv>;
+ 		regulator-name = "vcc_host1_5v";
diff --git a/target/linux/rockchip/patches-5.4/0003-rk3328_rock64_update_gpu_node.patch b/target/linux/rockchip/patches-5.4/0003-rk3328_rock64_update_gpu_node.patch
new file mode 100644
index 0000000000..51509253aa
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0003-rk3328_rock64_update_gpu_node.patch
@@ -0,0 +1,75 @@
+From 31d59999ccfda596f3a2b683d5c97e76b07936b0 Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 17 Mar 2019 22:38:09 +0000
+Subject: [PATCH] HACK: arm64: dts: rockchip: update gpu node on rk3328-rock64
+
+---
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 8 ++++----
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi       | 7 +++++++
+ 2 files changed, 11 insertions(+), 4 deletions(-)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index 989404a40955..e70c223871ac 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -193,8 +193,8 @@
+ 		regulators {
+ 			vdd_logic: DCDC_REG1 {
+ 				regulator-name = "vdd_logic";
+-				regulator-min-microvolt = <712500>;
+-				regulator-max-microvolt = <1450000>;
++				regulator-min-microvolt = <900000>;
++				regulator-max-microvolt = <1150000>;
+ 				regulator-ramp-delay = <12500>;
+ 				regulator-always-on;
+ 				regulator-boot-on;
+@@ -206,8 +206,8 @@
+ 
+ 			vdd_arm: DCDC_REG2 {
+ 				regulator-name = "vdd_arm";
+-				regulator-min-microvolt = <712500>;
+-				regulator-max-microvolt = <1450000>;
++				regulator-min-microvolt = <950000>;
++				regulator-max-microvolt = <1350000>;
+ 				regulator-ramp-delay = <12500>;
+ 				regulator-always-on;
+ 				regulator-boot-on;
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 0f300c01db83..8f0dc30e4289 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -302,6 +302,10 @@
+ 			#address-cells = <1>;
+ 			#size-cells = <0>;
+ 
++			pd_gpu@RK3328_PD_GPU {
++				reg = <RK3328_PD_GPU>;
++				clocks = <&cru ACLK_GPU>;
++			};
+ 			pd_hevc@RK3328_PD_HEVC {
+ 				reg = <RK3328_PD_HEVC>;
+ 			};
+@@ -604,6 +608,7 @@
+ 				  "ppmmu1";
+ 		clocks = <&cru ACLK_GPU>, <&cru ACLK_GPU>;
+ 		clock-names = "bus", "core";
++		power-domains = <&power RK3328_PD_GPU>;
+ 		resets = <&cru SRST_GPU_A>;
+ 	};
+ 
+@@ -776,6 +781,7 @@
+ 			<&cru ACLK_BUS_PRE>, <&cru HCLK_BUS_PRE>,
+ 			<&cru PCLK_BUS_PRE>, <&cru ACLK_PERI_PRE>,
+ 			<&cru HCLK_PERI>, <&cru PCLK_PERI>,
++			<&cru ACLK_GPU>,
+ 			<&cru SCLK_RTC32K>;
+ 		assigned-clock-parents =
+ 			<&cru HDMIPHY>, <&cru PLL_APLL>,
+@@ -797,6 +803,7 @@
+ 			<150000000>, <75000000>,
+ 			<75000000>, <150000000>,
+ 			<75000000>, <75000000>,
++			<500000000>,
+ 			<32768>;
+ 	};
+ 
diff --git a/target/linux/rockchip/patches-5.4/0004-rk3328_add_sdmmc_ext_node.patch b/target/linux/rockchip/patches-5.4/0004-rk3328_add_sdmmc_ext_node.patch
new file mode 100644
index 0000000000..bf765ba1ee
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0004-rk3328_add_sdmmc_ext_node.patch
@@ -0,0 +1,34 @@
+From 480b56effc7d96a1f87ee50e055ba2936fdad1f8 Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 29 Dec 2019 22:14:02 +0000
+Subject: [PATCH] arm64: dts: rockchip: add sdmmc_ext node on rk3328
+
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 14 ++++++++++++++
+ 1 file changed, 14 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 3c50c11c2e5b..1c8057c7bcd3 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -975,6 +975,20 @@
+ 		status = "disabled";
+ 	};
+ 
++	sdmmc_ext: dwmmc@ff5f0000 {
++		compatible = "rockchip,rk3328-dw-mshc", "rockchip,rk3288-dw-mshc";
++		reg = <0x0 0xff5f0000 0x0 0x4000>;
++		interrupts = <GIC_SPI 4 IRQ_TYPE_LEVEL_HIGH>;
++		clocks = <&cru HCLK_SDMMC_EXT>, <&cru SCLK_SDMMC_EXT>,
++			 <&cru SCLK_SDMMC_EXT_DRV>, <&cru SCLK_SDMMC_EXT_SAMPLE>;
++		clock-names = "biu", "ciu", "ciu-drive", "ciu-sample";
++		fifo-depth = <0x100>;
++		max-frequency = <150000000>;
++		resets = <&cru SRST_SDMMCEXT>;
++		reset-names = "reset";
++		status = "disabled";
++	};
++
+ 	gic: interrupt-controller@ff811000 {
+ 		compatible = "arm,gic-400";
+ 		#interrupt-cells = <3>;
diff --git a/target/linux/rockchip/patches-5.4/0005-rk3328_add_idle_state.patch b/target/linux/rockchip/patches-5.4/0005-rk3328_add_idle_state.patch
new file mode 100644
index 0000000000..1a62e29e1c
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0005-rk3328_add_idle_state.patch
@@ -0,0 +1,71 @@
+From 4f279f9fbca54464173240f7e73b145a136dfa1e Mon Sep 17 00:00:00 2001
+From: Robin Murphy <robin.murphy@arm.com>
+Date: Sun, 29 Dec 2019 20:16:17 +0000
+Subject: [PATCH] arm64: dts: rockchip: Add RK3328 idle state
+
+Downstream RK3328 DTBs describe a CPU idle state matching that present
+on other SoCs like RK3399. This works with upstream Trusted Firmware-A
+too, so let's add it here.
+
+Signed-off-by: Robin Murphy <robin.murphy@arm.com>
+Link: https://lore.kernel.org/r/a8c83e705d387446ea8121516d410e38b2d9c57b.1577640736.git.robin.murphy@arm.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 17 +++++++++++++++++
+ 1 file changed, 17 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 91306ebed4da..c9ff1188bd7b 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -41,6 +41,7 @@
+ 			reg = <0x0 0x0>;
+ 			clocks = <&cru ARMCLK>;
+ 			#cooling-cells = <2>;
++			cpu-idle-states = <&CPU_SLEEP>;
+ 			dynamic-power-coefficient = <120>;
+ 			enable-method = "psci";
+ 			next-level-cache = <&l2>;
+@@ -53,6 +54,7 @@
+ 			reg = <0x0 0x1>;
+ 			clocks = <&cru ARMCLK>;
+ 			#cooling-cells = <2>;
++			cpu-idle-states = <&CPU_SLEEP>;
+ 			dynamic-power-coefficient = <120>;
+ 			enable-method = "psci";
+ 			next-level-cache = <&l2>;
+@@ -65,6 +67,7 @@
+ 			reg = <0x0 0x2>;
+ 			clocks = <&cru ARMCLK>;
+ 			#cooling-cells = <2>;
++			cpu-idle-states = <&CPU_SLEEP>;
+ 			dynamic-power-coefficient = <120>;
+ 			enable-method = "psci";
+ 			next-level-cache = <&l2>;
+@@ -77,12 +80,26 @@
+ 			reg = <0x0 0x3>;
+ 			clocks = <&cru ARMCLK>;
+ 			#cooling-cells = <2>;
++			cpu-idle-states = <&CPU_SLEEP>;
+ 			dynamic-power-coefficient = <120>;
+ 			enable-method = "psci";
+ 			next-level-cache = <&l2>;
+ 			operating-points-v2 = <&cpu0_opp_table>;
+ 		};
+ 
++		idle-states {
++			entry-method = "psci";
++
++			CPU_SLEEP: cpu-sleep {
++				compatible = "arm,idle-state";
++				local-timer-stop;
++				arm,psci-suspend-param = <0x0010000>;
++				entry-latency-us = <120>;
++				exit-latency-us = <250>;
++				min-residency-us = <900>;
++			};
++		};
++
+ 		l2: l2-cache0 {
+ 			compatible = "cache";
+ 		};
diff --git a/target/linux/rockchip/patches-5.4/0006-rk3328_add_mmc_reset.patch b/target/linux/rockchip/patches-5.4/0006-rk3328_add_mmc_reset.patch
new file mode 100644
index 0000000000..94ba900f93
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0006-rk3328_add_mmc_reset.patch
@@ -0,0 +1,40 @@
+From 764e6cf1c0ffcfdbac7a259bc3ce4a7c4f221f75 Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 29 Dec 2019 22:13:22 +0000
+Subject: [PATCH] arm64: dts: rockchip: add mmc reset on rk3328
+
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 6 ++++++
+ 1 file changed, 6 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 635f68fdc85c..3c50c11c2e5b 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -870,6 +870,8 @@
+ 		clock-names = "biu", "ciu", "ciu-drive", "ciu-sample";
+ 		fifo-depth = <0x100>;
+ 		max-frequency = <150000000>;
++		resets = <&cru SRST_MMC0>;
++		reset-names = "reset";
+ 		status = "disabled";
+ 	};
+ 
+@@ -882,6 +884,8 @@
+ 		clock-names = "biu", "ciu", "ciu-drive", "ciu-sample";
+ 		fifo-depth = <0x100>;
+ 		max-frequency = <150000000>;
++		resets = <&cru SRST_SDIO>;
++		reset-names = "reset";
+ 		status = "disabled";
+ 	};
+ 
+@@ -894,6 +898,8 @@
+ 		clock-names = "biu", "ciu", "ciu-drive", "ciu-sample";
+ 		fifo-depth = <0x100>;
+ 		max-frequency = <150000000>;
++		resets = <&cru SRST_EMMC>;
++		reset-names = "reset";
+ 		status = "disabled";
+ 	};
+ 
diff --git a/target/linux/rockchip/patches-5.4/0007-add_gpu_supply.patch b/target/linux/rockchip/patches-5.4/0007-add_gpu_supply.patch
new file mode 100644
index 0000000000..3c88e27cf5
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0007-add_gpu_supply.patch
@@ -0,0 +1,27 @@
+From d27f74c86a2d224e47e2af26c2aadeda229e240d Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 8 Dec 2019 23:26:37 +0000
+Subject: [PATCH] WIP: arm64: dts: rockchip: add mali-supply on rk3328-rock64
+ and rk3328-roc-cc
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 4 ++++
+ 1 files changed, 4 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index e926616b4a0c..9023f311f89b 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -138,6 +138,10 @@
+ 	status = "okay";
+ };
+ 
++&gpu {
++	mali-supply = <&vdd_logic>;
++};
++
+ &hdmi {
+ 	status = "okay";
+ };
+
diff --git a/target/linux/rockchip/patches-5.4/0008-rock64_add_spi_flash_partitions.patch b/target/linux/rockchip/patches-5.4/0008-rock64_add_spi_flash_partitions.patch
new file mode 100644
index 0000000000..3468e3f66f
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0008-rock64_add_spi_flash_partitions.patch
@@ -0,0 +1,39 @@
+From 61beaf04441cc521320136cb57b5a42627f0c34a Mon Sep 17 00:00:00 2001
+From: =?UTF-8?q?Kamil=20Trzci=C5=84ski?= <ayufan@ayufan.eu>
+Date: Sat, 25 May 2019 19:49:57 +0200
+Subject: [PATCH] ayufan: dts: rock64: add spi-flash partitions
+
+Change-Id: I4a925da14a95e2fcce5c9b8d1c4faca3028dd2eb
+---
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 14 +++++++++++++-
+ 1 file changed, 13 insertions(+), 1 deletion(-)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index dcb336b49f9bd..d873c17510e93 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -348,11 +348,23 @@
+ 	status = "okay";
+ 
+ 	spiflash@0 {
+-		compatible = "jedec,spi-nor";
++		compatible = "gigadevice,gd25q128", "jedec,spi-nor";
+ 		reg = <0>;
++		m25p,fast-read;
+ 
+ 		/* maximum speed for Rockchip SPI */
+ 		spi-max-frequency = <50000000>;
++
++		partitions {
++			compatible = "fixed-partitions";
++			#address-cells = <1>;
++			#size-cells = <1>;
++
++			loader@8000 {
++				label = "loader";
++				reg = <0x8000 0x3F0000>;
++			};
++		};
+ 	};
+ };
+ 
diff --git a/target/linux/rockchip/patches-5.4/0009-rk3328_add_rkvdec_power_domain.patch b/target/linux/rockchip/patches-5.4/0009-rk3328_add_rkvdec_power_domain.patch
new file mode 100644
index 0000000000..e15dd9c9cc
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0009-rk3328_add_rkvdec_power_domain.patch
@@ -0,0 +1,32 @@
+From a0799da14605e46f6231713438bb7f7c85c2380a Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 29 Dec 2019 22:14:36 +0000
+Subject: [PATCH] WIP: arm64: dts: rockchip: add rkvdec power domain on rk3328
+
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 5 +++++
+ 1 file changed, 5 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 1c8057c7bcd3..8c9b7c3fcee4 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -348,6 +348,10 @@
+ 			};
+ 			pd_video@RK3328_PD_VIDEO {
+ 				reg = <RK3328_PD_VIDEO>;
++				clocks = <&cru ACLK_RKVDEC>,
++					 <&cru HCLK_RKVDEC>,
++					 <&cru SCLK_VDEC_CABAC>,
++					 <&cru SCLK_VDEC_CORE>;
+ 			};
+ 			pd_vpu@RK3328_PD_VPU {
+ 				reg = <RK3328_PD_VPU>;
+@@ -701,6 +705,7 @@
+ 		clocks = <&cru ACLK_RKVDEC>, <&cru HCLK_RKVDEC>;
+ 		clock-names = "aclk", "iface";
+ 		#iommu-cells = <0>;
++		power-domains = <&power RK3328_PD_VIDEO>;
+ 		status = "disabled";
+ 	};
+ 
diff --git a/target/linux/rockchip/patches-5.4/0011-rk3328_rock64_fix_vccio4_supply.patch b/target/linux/rockchip/patches-5.4/0011-rk3328_rock64_fix_vccio4_supply.patch
new file mode 100644
index 0000000000..f82203b821
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0011-rk3328_rock64_fix_vccio4_supply.patch
@@ -0,0 +1,22 @@
+From ccd937acdd96bcae396d0e5b1167f79d3a6a118b Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Sun, 21 Apr 2019 18:13:30 +0000
+Subject: [PATCH] arm64: dts: rockchip: fix vccio4-supply on rk3328-rock64
+
+---
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index 3725fcc7bb38..1af6c56a4451 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -314,7 +314,7 @@
+ 	vccio1-supply = <&vcc_io>;
+ 	vccio2-supply = <&vcc18_emmc>;
+ 	vccio3-supply = <&vcc_io>;
+-	vccio4-supply = <&vcc_18>;
++	vccio4-supply = <&vcc_io>;
+ 	vccio5-supply = <&vcc_io>;
+ 	vccio6-supply = <&vcc_io>;
+ 	pmuio-supply = <&vcc_io>;
diff --git a/target/linux/rockchip/patches-5.4/0012-rk3328_fix_wrong_mmc_shift.patch b/target/linux/rockchip/patches-5.4/0012-rk3328_fix_wrong_mmc_shift.patch
new file mode 100644
index 0000000000..de7a866710
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0012-rk3328_fix_wrong_mmc_shift.patch
@@ -0,0 +1,48 @@
+From 6376a1b0e30a1d30c4269083fb5b9a146a944ada Mon Sep 17 00:00:00 2001
+From: Ziyuan Xu <xzy.xu@rock-chips.com>
+Date: Wed, 28 Nov 2018 17:39:50 +0800
+Subject: [PATCH] Revert "clk: rockchip: fix wrong mmc phase shift for rk3328"
+
+This reverts commit 4ef244988993afc8a6447e990a4ccb4a223d3f20.
+
+The description for CRU_EMMC/SDMMC/SDIO_CON[0/1] is jumble on
+chapters, make it clear that the correct shift is 1 that from
+IC engineer.
+
+Change-Id: I48dce293ec6ef82a5c78db38efc083227776ea99
+Signed-off-by: Ziyuan Xu <xzy.xu@rock-chips.com>
+---
+ drivers/clk/rockchip/clk-rk3328.c | 8 ++++----
+ 1 file changed, 4 insertions(+), 4 deletions(-)
+
+diff --git a/drivers/clk/rockchip/clk-rk3328.c b/drivers/clk/rockchip/clk-rk3328.c
+index ac6e6163a232..d77925271198 100644
+--- a/drivers/clk/rockchip/clk-rk3328.c
++++ b/drivers/clk/rockchip/clk-rk3328.c
+@@ -808,22 +808,22 @@ static struct rockchip_clk_branch rk3328_clk_branches[] __initdata = {
+ 	MMC(SCLK_SDMMC_DRV, "sdmmc_drv", "clk_sdmmc",
+ 	    RK3328_SDMMC_CON0, 1),
+ 	MMC(SCLK_SDMMC_SAMPLE, "sdmmc_sample", "clk_sdmmc",
+-	    RK3328_SDMMC_CON1, 0),
++	    RK3328_SDMMC_CON1, 1),
+ 
+ 	MMC(SCLK_SDIO_DRV, "sdio_drv", "clk_sdio",
+ 	    RK3328_SDIO_CON0, 1),
+ 	MMC(SCLK_SDIO_SAMPLE, "sdio_sample", "clk_sdio",
+-	    RK3328_SDIO_CON1, 0),
++	    RK3328_SDIO_CON1, 1),
+ 
+ 	MMC(SCLK_EMMC_DRV, "emmc_drv", "clk_emmc",
+ 	    RK3328_EMMC_CON0, 1),
+ 	MMC(SCLK_EMMC_SAMPLE, "emmc_sample", "clk_emmc",
+-	    RK3328_EMMC_CON1, 0),
++	    RK3328_EMMC_CON1, 1),
+ 
+ 	MMC(SCLK_SDMMC_EXT_DRV, "sdmmc_ext_drv", "clk_sdmmc_ext",
+ 	    RK3328_SDMMC_EXT_CON0, 1),
+ 	MMC(SCLK_SDMMC_EXT_SAMPLE, "sdmmc_ext_sample", "clk_sdmmc_ext",
+-	    RK3328_SDMMC_EXT_CON1, 0),
++	    RK3328_SDMMC_EXT_CON1, 1),
+ };
+ 
+ static const char *const rk3328_critical_clocks[] __initconst = {
diff --git a/target/linux/rockchip/patches-5.4/0014-remove_deprecated_g_dma.patch b/target/linux/rockchip/patches-5.4/0014-remove_deprecated_g_dma.patch
new file mode 100644
index 0000000000..b3e5f7c620
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0014-remove_deprecated_g_dma.patch
@@ -0,0 +1,52 @@
+From e9b6044dceeff4ec93a538df9bef28574a4c3673 Mon Sep 17 00:00:00 2001
+From: Johan Jonker <jbx6244@gmail.com>
+Date: Fri, 28 Feb 2020 12:39:22 +0100
+Subject: arm64: dts: remove g-use-dma from rockchip usb nodes
+
+A test with the command below gives these errors:
+
+arch/arm64/boot/dts/rockchip/px30-evb.dt.yaml: usb@ff300000:
+'g-use-dma', 'power-domains' do not match any of the regexes:
+'pinctrl-[0-9]+'
+arch/arm64/boot/dts/rockchip/rk3328-a1.dt.yaml: usb@ff580000:
+'g-use-dma' does not match any of the regexes: 'pinctrl-[0-9]+'
+arch/arm64/boot/dts/rockchip/rk3328-evb.dt.yaml: usb@ff580000:
+'g-use-dma' does not match any of the regexes: 'pinctrl-[0-9]+'
+arch/arm64/boot/dts/rockchip/rk3328-rock64.dt.yaml: usb@ff580000:
+'g-use-dma' does not match any of the regexes: 'pinctrl-[0-9]+'
+arch/arm64/boot/dts/rockchip/rk3328-roc-cc.dt.yaml: usb@ff580000:
+'g-use-dma' does not match any of the regexes: 'pinctrl-[0-9]+'
+
+'g-use-dma' is not a valid option in dwc2.yaml, so remove it
+from all Rockchip dtsi files.
+
+make ARCH=arm64 dtbs_check
+DT_SCHEMA_FILES=Documentation/devicetree/bindings/usb/dwc2.yaml
+
+g-use-dma was deprecated in november 2016, see
+https://patchwork.kernel.org/patch/9420553/
+
+Signed-off-by: Johan Jonker <jbx6244@gmail.com>
+Link: https://lore.kernel.org/r/20200228113922.20266-2-jbx6244@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 1 -
+ 1 file changed, 1 deletion(-)
+
+(limited to 'arch/arm64/boot/dts/rockchip/rk3328.dtsi')
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 1f53ead52c7f..bad41bc6f2d5 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -957,7 +957,6 @@
+ 		g-np-tx-fifo-size = <16>;
+ 		g-rx-fifo-size = <280>;
+ 		g-tx-fifo-size = <256 128 128 64 32 16>;
+-		g-use-dma;
+ 		phys = <&u2phy_otg>;
+ 		phy-names = "usb2-phy";
+ 		status = "disabled";
+-- 
+cgit 1.2-0.3.lf.el7
+
diff --git a/target/linux/rockchip/patches-5.4/0015-bus_to_rockchip_amba_nodenames.patch b/target/linux/rockchip/patches-5.4/0015-bus_to_rockchip_amba_nodenames.patch
new file mode 100644
index 0000000000..753e3f86b8
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0015-bus_to_rockchip_amba_nodenames.patch
@@ -0,0 +1,45 @@
+From b2411befed603011826b8783c370a086b5cee163 Mon Sep 17 00:00:00 2001
+From: Johan Jonker <jbx6244@gmail.com>
+Date: Mon, 2 Mar 2020 16:30:47 +0100
+Subject: arm64: dts: add bus to rockchip amba nodenames
+
+A test with the command below gives for example this error:
+
+arch/arm64/boot/dts/rockchip/rk3399-evb.dt.yaml: amba: $nodename:0:
+'amba' does not match
+'^(bus|soc|axi|ahb|apb)(@[0-9a-f]+)?$'
+
+AMBA is a open standard for the connection and
+management of functional blocks in a SoC.
+It's compatible with 'simple-bus', so fix this error
+by adding 'bus' to all Rockchip 'amba' nodes.
+
+make ARCH=arm64 dtbs_check
+DT_SCHEMA_FILES=~/.local/lib/python3.5/site-packages/dtschema/
+schemas/simple-bus.yaml
+
+Signed-off-by: Johan Jonker <jbx6244@gmail.com>
+Link: https://lore.kernel.org/r/20200302153047.17101-2-jbx6244@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+(limited to 'arch/arm64/boot/dts/rockchip/rk3328.dtsi')
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 2aefb38f7368..7abbc8dc1bc2 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -142,7 +142,7 @@
+ 		};
+ 	};
+ 
+-	amba {
++	amba: bus {
+ 		compatible = "simple-bus";
+ 		#address-cells = <2>;
+ 		#size-cells = <2>;
+-- 
+cgit 1.2-0.3.lf.el7
+
diff --git a/target/linux/rockchip/patches-5.4/0016-remove_clock-names_property_from_usb.patch b/target/linux/rockchip/patches-5.4/0016-remove_clock-names_property_from_usb.patch
new file mode 100644
index 0000000000..6a879106f9
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0016-remove_clock-names_property_from_usb.patch
@@ -0,0 +1,82 @@
+From 6a92e52bae81473f8ac9a06556153176e70114a9 Mon Sep 17 00:00:00 2001
+From: Johan Jonker <jbx6244@gmail.com>
+Date: Thu, 12 Mar 2020 18:14:40 +0100
+Subject: arm64: dts: rockchip: remove clock-names property from 'generic-ehci'
+ nodes
+
+A test with the command below gives for example this error:
+
+arch/arm64/boot/dts/rockchip/rk3328-evb.dt.yaml: usb@ff5c0000:
+'clock-names' does not match any of the regexes: 'pinctrl-[0-9]+'
+
+'clock-names' is not a valid property name for usb_host nodes with
+compatible string 'generic-ehci', so remove them.
+
+make ARCH=arm64 dtbs_check
+DT_SCHEMA_FILES=Documentation/devicetree/bindings/usb/generic-ehci.yaml
+
+Signed-off-by: Johan Jonker <jbx6244@gmail.com>
+Link: https://lore.kernel.org/r/20200312171441.21144-3-jbx6244@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 1 -
+ 1 file changed, 1 deletion(-)
+
+(limited to 'arch/arm64/boot/dts/rockchip/rk3328.dtsi')
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 7abbc8dc1bc2..39a8b19f401d 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -969,7 +969,6 @@
+ 		reg = <0x0 0xff5c0000 0x0 0x10000>;
+ 		interrupts = <GIC_SPI 16 IRQ_TYPE_LEVEL_HIGH>;
+ 		clocks = <&cru HCLK_HOST0>, <&u2phy>;
+-		clock-names = "usbhost", "utmi";
+ 		phys = <&u2phy_host>;
+ 		phy-names = "usb";
+ 		status = "disabled";
+-- 
+cgit 1.2-0.3.lf.el7
+
+From 77460b3d7d794fd30c010958c2346cc9ac5aadd4 Mon Sep 17 00:00:00 2001
+From: Johan Jonker <jbx6244@gmail.com>
+Date: Thu, 12 Mar 2020 18:14:41 +0100
+Subject: arm64: dts: rockchip: remove clock-names property from 'generic-ohci'
+ nodes
+
+A test with the command below gives for example this error:
+
+arch/arm64/boot/dts/rockchip/rk3328-evb.dt.yaml: usb@ff5d0000:
+'clock-names' does not match any of the regexes: 'pinctrl-[0-9]+'
+
+'clock-names' is not a valid property name for usb_host nodes with
+compatible string 'generic-ohci', so remove them.
+
+make ARCH=arm64 dtbs_check
+DT_SCHEMA_FILES=Documentation/devicetree/bindings/usb/generic-ohci.yaml
+
+Signed-off-by: Johan Jonker <jbx6244@gmail.com>
+Link: https://lore.kernel.org/r/20200312171441.21144-4-jbx6244@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 1 -
+ 1 file changed, 1 deletion(-)
+
+(limited to 'arch/arm64/boot/dts/rockchip/rk3328.dtsi')
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 39a8b19f401d..7e88d88aab98 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -979,7 +979,6 @@
+ 		reg = <0x0 0xff5d0000 0x0 0x10000>;
+ 		interrupts = <GIC_SPI 17 IRQ_TYPE_LEVEL_HIGH>;
+ 		clocks = <&cru HCLK_HOST0>, <&u2phy>;
+-		clock-names = "usbhost", "utmi";
+ 		phys = <&u2phy_host>;
+ 		phy-names = "usb";
+ 		status = "disabled";
+-- 
+cgit 1.2-0.3.lf.el7
+
diff --git a/target/linux/rockchip/patches-5.4/0020-misc_supply_fixes.patch b/target/linux/rockchip/patches-5.4/0020-misc_supply_fixes.patch
new file mode 100644
index 0000000000..7775c122a1
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0020-misc_supply_fixes.patch
@@ -0,0 +1,97 @@
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index 9023f311f89b..345c045c58e6 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -32,7 +32,7 @@
+ 		vin-supply = <&vcc_io>;
+ 	};
+ 
+-	vcc_host_5v: vcc-host-5v-regulator {
++	vcc_host_5v: vcc_host1_5v: vcc_otg_5v: vcc-host-5v-regulator {
+ 		compatible = "regulator-fixed";
+ 		gpio = <&gpio0 RK_PA2 GPIO_ACTIVE_HIGH>;
+ 		pinctrl-names = "default";
+@@ -43,22 +43,9 @@
+ 		vin-supply = <&vcc_sys>;
+ 	};
+ 
+-	vcc_host1_5v: vcc_otg_5v: vcc-host1-5v-regulator {
+-		compatible = "regulator-fixed";
+-		gpio = <&gpio0 RK_PA2 GPIO_ACTIVE_HIGH>;
+-		pinctrl-names = "default";
+-		pinctrl-0 = <&usb20_host_drv>;
+-		regulator-name = "vcc_host1_5v";
+-		regulator-always-on;
+-		regulator-boot-on;
+-		vin-supply = <&vcc_sys>;
+-	};
+-
+ 	vcc_sys: vcc-sys {
+ 		compatible = "regulator-fixed";
+ 		regulator-name = "vcc_sys";
+-		regulator-always-on;
+-		regulator-boot-on;
+ 		regulator-min-microvolt = <5000000>;
+ 		regulator-max-microvolt = <5000000>;
+ 	};
+@@ -112,6 +99,7 @@
+ &emmc {
+ 	bus-width = <8>;
+ 	cap-mmc-highspeed;
++	mmc-ddr-1_8v;
+ 	mmc-hs200-1_8v;
+ 	non-removable;
+ 	pinctrl-names = "default";
+@@ -125,11 +113,12 @@
+ 	assigned-clocks = <&cru SCLK_MAC2IO>, <&cru SCLK_MAC2IO_EXT>;
+ 	assigned-clock-parents = <&gmac_clkin>, <&gmac_clkin>;
+ 	clock_in_out = "input";
+-	phy-supply = <&vcc_io>;
+ 	phy-mode = "rgmii";
++	phy-supply = <&vcc_io>;
+ 	pinctrl-names = "default";
+ 	pinctrl-0 = <&rgmiim1_pins>;
+-	snps,force_thresh_dma_mode;
++	snps,aal;
++	snps,pbl = <0x4>;
+ 	snps,reset-gpio = <&gpio1 RK_PC2 GPIO_ACTIVE_LOW>;
+ 	snps,reset-active-low;
+ 	snps,reset-delays-us = <0 10000 50000>;
+@@ -176,7 +165,7 @@
+ 		vcc3-supply = <&vcc_sys>;
+ 		vcc4-supply = <&vcc_sys>;
+ 		vcc5-supply = <&vcc_io>;
+-		vcc6-supply = <&vcc_sys>;
++		vcc6-supply = <&vcc_io>;
+ 
+ 		regulators {
+ 			vdd_logic: DCDC_REG1 {
+@@ -310,7 +298,6 @@
+ 	cap-mmc-highspeed;
+ 	cap-sd-highspeed;
+ 	disable-wp;
+-	max-frequency = <150000000>;
+ 	pinctrl-names = "default";
+ 	pinctrl-0 = <&sdmmc0_clk &sdmmc0_cmd &sdmmc0_dectn &sdmmc0_bus4>;
+ 	vmmc-supply = <&vcc_sd>;
+@@ -354,14 +341,14 @@
+ 
+ &u2phy {
+ 	status = "okay";
++};
+ 
+-	u2phy_host: host-port {
+-		status = "okay";
+-	};
++&u2phy_host {
++	status = "okay";
++};
+ 
+-	u2phy_otg: otg-port {
+-		status = "okay";
+-	};
++&u2phy_otg {
++	status = "okay";
+ };
+ 
+ &usb20_otg {
diff --git a/target/linux/rockchip/patches-5.4/0021-usb3_fixes.patch b/target/linux/rockchip/patches-5.4/0021-usb3_fixes.patch
new file mode 100644
index 0000000000..92ce9ed600
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0021-usb3_fixes.patch
@@ -0,0 +1,126 @@
+From 47617b87407d583ed22591a565b6e1bb716b2876 Mon Sep 17 00:00:00 2001
+From: William Wu <william.wu@rock-chips.com>
+Date: Mon, 4 Dec 2017 10:40:38 +0100
+Subject: [PATCH] dt-bindings: usb: add DT binding for RK3328 dwc3 controller
+
+Adds the device tree bindings description for RK3328 and
+compatible USB DWC3 controller.
+
+Signed-off-by: William Wu <william.wu@rock-chips.com>
+Acked-by: Rob Herring <robh@kernel.org>
+Acked-by: Felipe Balbi <felipe.balbi@linux.intel.com>
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ Documentation/devicetree/bindings/usb/rockchip,dwc3.txt | 4 +++-
+ 1 file changed, 3 insertions(+), 1 deletion(-)
+
+diff --git a/Documentation/devicetree/bindings/usb/rockchip,dwc3.txt b/Documentation/devicetree/bindings/usb/rockchip,dwc3.txt
+index c8c4b00ecb94..4ca357835a48 100644
+--- a/Documentation/devicetree/bindings/usb/rockchip,dwc3.txt
++++ b/Documentation/devicetree/bindings/usb/rockchip,dwc3.txt
+@@ -1,7 +1,9 @@
+ Rockchip SuperSpeed DWC3 USB SoC controller
+ 
+ Required properties:
+-- compatible:	should contain "rockchip,rk3399-dwc3" for rk3399 SoC
++- compatible:	should be one of the following:
++  - "rockchip,rk3399-dwc3": for rk3399 SoC
++  - "rockchip,rk3328-dwc3", "rockchip,rk3399-dwc3": for rk3328 SoC
+ - clocks:	A list of phandle + clock-specifier pairs for the
+ 		clocks listed in clock-names
+ - clock-names:	Should contain the following:
+
+From 45d171c2532e90406a72aa1c24a8d6a7b6d32e67 Mon Sep 17 00:00:00 2001
+From: William Wu <william.wu@rock-chips.com>
+Date: Mon, 4 Dec 2017 10:40:39 +0100
+Subject: [PATCH] arm64: dts: rockchip: add usb3 controller node for RK3328
+ SoCs
+
+RK3328 has one USB 3.0 OTG controller which uses DWC_USB3
+core's general architecture. It can act as static xHCI host
+controller, static device controller, USB 3.0/2.0 OTG basing
+on ID of USB3.0 PHY.
+
+Signed-off-by: William Wu <william.wu@rock-chips.com>
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 32 ++++++++++++++++++++++++++++++++
+ 1 file changed, 32 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 8c9b7c3fcee4..901c525deb27 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -1020,6 +1020,38 @@
+ 		status = "disabled";
+ 	};
+ 
++	usbdrd3: usb@ff600000 {
++		compatible = "rockchip,rk3328-dwc3", "rockchip,rk3399-dwc3";
++		clocks = <&cru SCLK_USB3OTG_REF>, <&cru SCLK_USB3OTG_SUSPEND>,
++			 <&cru ACLK_USB3OTG>;
++		clock-names = "ref_clk", "suspend_clk",
++			      "bus_clk";
++		resets = <&cru SRST_USB3OTG>;
++		reset-names = "usb3-otg";
++		#address-cells = <2>;
++		#size-cells = <2>;
++		ranges;
++		status = "disabled";
++
++		usbdrd_dwc3: dwc3@ff600000 {
++			compatible = "snps,dwc3";
++			reg = <0x0 0xff600000 0x0 0x100000>;
++			interrupts = <GIC_SPI 67 IRQ_TYPE_LEVEL_HIGH>;
++			clocks = <&cru SCLK_USB3OTG_REF>, <&cru ACLK_USB3OTG>,
++				 <&cru SCLK_USB3OTG_SUSPEND>;
++			clock-names = "ref", "bus_early", "suspend";
++			dr_mode = "otg";
++			phy_type = "utmi_wide";
++			snps,dis_enblslpm_quirk;
++			snps,dis-u2-freeclk-exists-quirk;
++			snps,dis_u2_susphy_quirk;
++			snps,dis_u3_susphy_quirk;
++			snps,dis-del-phy-power-chg-quirk;
++			snps,dis-tx-ipgap-linecheck-quirk;
++			status = "disabled";
++		};
++	};
++
+ 	gic: interrupt-controller@ff811000 {
+ 		compatible = "arm,gic-400";
+ 		#interrupt-cells = <3>;
+
+From 52d7041671876e508888c5fa892a23e2a0cd1874 Mon Sep 17 00:00:00 2001
+From: Heiko Stuebner <heiko@sntech.de>
+Date: Mon, 4 Dec 2017 10:40:41 +0100
+Subject: [PATCH] arm64: dts: rockchip: enable usb3 nodes on rk3328-rock64
+
+Enable the nodes to make the usb3 port usable on that board.
+
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 9 +++++++++
+ 1 file changed, 9 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index 345c045c58e6..1cc3a8f5c3d7 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -364,6 +364,15 @@
+ 	status = "okay";
+ };
+ 
++&usbdrd3 {
++	status = "okay";
++};
++
++&usbdrd_dwc3 {
++	dr_mode = "host";
++	status = "okay";
++};
++
+ &vop {
+ 	status = "okay";
+ };
+
diff --git a/target/linux/rockchip/patches-5.4/0022-Make_RK3328_GPIO_MUTE_control_explicit.patch b/target/linux/rockchip/patches-5.4/0022-Make_RK3328_GPIO_MUTE_control_explicit.patch
new file mode 100644
index 0000000000..7dc2118c1b
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0022-Make_RK3328_GPIO_MUTE_control_explicit.patch
@@ -0,0 +1,50 @@
+From: Robin Murphy <robin.murphy@arm.com>
+To: lgirdwood@gmail.com,
+	broonie@kernel.org,
+	heiko@sntech.de
+Subject: [PATCH v2 1/3] ASoC: dt-bindings: Make RK3328 codec GPIO explicit
+Date: Tue, 18 Feb 2020 21:31:58 +0000
+
+Existing RK3328 codec drivers have overloaded the GRF phandle to assume
+implicit control of the limited-function GPIO_MUTE pin, which is usually
+used to enable an external audio line driver IC. Since this pin has a
+proper binding of its own (see gpio/rockchip,rk3328-grf-gpio.txt), make
+a GPIO explicit in the codec binding too. This will help avoid ambiguity
+on boards that use that pin for some other purpose.
+
+(and while touching the example, enforce the "don't include status" rule)
+
+Signed-off-by: Robin Murphy <robin.murphy@arm.com>
+Acked-by: Rob Herring <robh@kernel.org>
+---
+
+v2: no change
+
+ .../devicetree/bindings/sound/rockchip,rk3328-codec.txt    | 7 ++++++-
+ 1 file changed, 6 insertions(+), 1 deletion(-)
+
+diff --git a/Documentation/devicetree/bindings/sound/rockchip,rk3328-codec.txt b/Documentation/devicetree/bindings/sound/rockchip,rk3328-codec.txt
+index 2469588c7ccb..1ecd75d2032a 100644
+--- a/Documentation/devicetree/bindings/sound/rockchip,rk3328-codec.txt
++++ b/Documentation/devicetree/bindings/sound/rockchip,rk3328-codec.txt
+@@ -10,6 +10,11 @@ Required properties:
+ - clock-names: should be "pclk".
+ - spk-depop-time-ms: speak depop time msec.
+ 
++Optional properties:
++
++- mute-gpios: GPIO specifier for external line driver control (typically the
++              dedicated GPIO_MUTE pin)
++
+ Example for rk3328 internal codec:
+ 
+ codec: codec@ff410000 {
+@@ -18,6 +23,6 @@ codec: codec@ff410000 {
+ 	rockchip,grf = <&grf>;
+ 	clocks = <&cru PCLK_ACODEC>;
+ 	clock-names = "pclk";
++	mute-gpios = <&grf_gpio 0 GPIO_ACTIVE_LOW>;
+ 	spk-depop-time-ms = 100;
+-	status = "disabled";
+ };
+ 
diff --git a/target/linux/rockchip/patches-5.4/0023-Make_RK3328_GPIO_MUTE_control_explicit.patch b/target/linux/rockchip/patches-5.4/0023-Make_RK3328_GPIO_MUTE_control_explicit.patch
new file mode 100644
index 0000000000..f1b39f501b
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0023-Make_RK3328_GPIO_MUTE_control_explicit.patch
@@ -0,0 +1,111 @@
+From: Robin Murphy <robin.murphy@arm.com>
+To: lgirdwood@gmail.com,
+	broonie@kernel.org,
+	heiko@sntech.de
+Subject: [PATCH v2 2/3] ASoC: rockchip: Make RK3328 GPIO_MUTE control explicit
+Date: Tue, 18 Feb 2020 21:31:59 +0000
+
+The RK3328 reference design uses an external line driver IC as a buffer
+on the analog codec output, enabled by the GPIO_MUTE pin, and such a
+configuration is currently assumed in the codec driver's direct poking
+of GRF_SOC_CON10 to control the GPIO_MUTE output value. However, some
+boards wire up analog audio yet use that pin for some other purpose, so
+that assumption doesn't always hold. Update this functionality to rely
+on an explicit GPIO descriptor, such that it can be managed at the
+board level.
+
+Signed-off-by: Robin Murphy <robin.murphy@arm.com>
+---
+
+v2:
+ - add fallback case to avoid possible Rock64 regressions
+ - propagate GPIO errors; "optional" doesn't really mean "ignore
+   brokenness if present"
+
+ sound/soc/codecs/rk3328_codec.c | 31 ++++++++++++++++---------------
+ 1 file changed, 16 insertions(+), 15 deletions(-)
+
+diff --git a/sound/soc/codecs/rk3328_codec.c b/sound/soc/codecs/rk3328_codec.c
+index 287c962ba00d..115706a55577 100644
+--- a/sound/soc/codecs/rk3328_codec.c
++++ b/sound/soc/codecs/rk3328_codec.c
+@@ -7,6 +7,7 @@
+ #include <linux/clk.h>
+ #include <linux/delay.h>
+ #include <linux/device.h>
++#include <linux/gpio/consumer.h>
+ #include <linux/module.h>
+ #include <linux/of.h>
+ #include <linux/platform_device.h>
+@@ -31,7 +32,7 @@
+ 
+ struct rk3328_codec_priv {
+ 	struct regmap *regmap;
+-	struct regmap *grf;
++	struct gpio_desc *mute;
+ 	struct clk *mclk;
+ 	struct clk *pclk;
+ 	unsigned int sclk;
+@@ -106,16 +107,6 @@ static int rk3328_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)
+ 	return 0;
+ }
+ 
+-static void rk3328_analog_output(struct rk3328_codec_priv *rk3328, int mute)
+-{
+-	unsigned int val = BIT(17);
+-
+-	if (mute)
+-		val |= BIT(1);
+-
+-	regmap_write(rk3328->grf, RK3328_GRF_SOC_CON10, val);
+-}
+-
+ static int rk3328_digital_mute(struct snd_soc_dai *dai, int mute)
+ {
+ 	struct rk3328_codec_priv *rk3328 =
+@@ -205,7 +196,7 @@ static int rk3328_codec_open_playback(struct rk3328_codec_priv *rk3328)
+ 	}
+ 
+ 	msleep(rk3328->spk_depop_time);
+-	rk3328_analog_output(rk3328, 1);
++	gpiod_set_value(rk3328->mute, 0);
+ 
+ 	regmap_update_bits(rk3328->regmap, HPOUTL_GAIN_CTRL,
+ 			   HPOUTL_GAIN_MASK, OUT_VOLUME);
+@@ -246,7 +237,7 @@ static int rk3328_codec_close_playback(struct rk3328_codec_priv *rk3328)
+ {
+ 	size_t i;
+ 
+-	rk3328_analog_output(rk3328, 0);
++	gpiod_set_value(rk3328->mute, 1);
+ 
+ 	regmap_update_bits(rk3328->regmap, HPOUTL_GAIN_CTRL,
+ 			   HPOUTL_GAIN_MASK, 0);
+@@ -446,7 +437,6 @@ static int rk3328_platform_probe(struct platform_device *pdev)
+ 		dev_err(&pdev->dev, "missing 'rockchip,grf'\n");
+ 		return PTR_ERR(grf);
+ 	}
+-	rk3328->grf = grf;
+ 	/* enable i2s_acodec_en */
+ 	regmap_write(grf, RK3328_GRF_SOC_CON2,
+ 		     (BIT(14) << 16 | BIT(14)));
+@@ -458,7 +448,18 @@ static int rk3328_platform_probe(struct platform_device *pdev)
+ 		rk3328->spk_depop_time = 200;
+ 	}
+ 
+-	rk3328_analog_output(rk3328, 0);
++	rk3328->mute = gpiod_get_optional(&pdev->dev, "mute", GPIOD_OUT_HIGH);
++	if (IS_ERR(rk3328->mute))
++		return PTR_ERR(rk3328->mute);
++	/*
++	 * Rock64 is the only supported platform to have widely relied on
++	 * this; if we do happen to come across an old DTB, just leave the
++	 * external mute forced off.
++	 */
++	if (!rk3328->mute && of_machine_is_compatible("pine64,rock64")) {
++		dev_warn(&pdev->dev, "assuming implicit control of GPIO_MUTE; update devicetree if possible\n");
++		regmap_write(grf, RK3328_GRF_SOC_CON10, BIT(17) | BIT(1));
++	}
+ 
+ 	rk3328->mclk = devm_clk_get(&pdev->dev, "mclk");
+ 	if (IS_ERR(rk3328->mclk))
diff --git a/target/linux/rockchip/patches-5.4/0024-Make_RK3328_GPIO_MUTE_control_explicit.patch b/target/linux/rockchip/patches-5.4/0024-Make_RK3328_GPIO_MUTE_control_explicit.patch
new file mode 100644
index 0000000000..f9b4d89bcf
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0024-Make_RK3328_GPIO_MUTE_control_explicit.patch
@@ -0,0 +1,30 @@
+From: Robin Murphy <robin.murphy@arm.com>
+To: lgirdwood@gmail.com,
+	broonie@kernel.org,
+	heiko@sntech.de
+Subject: [PATCH v2 3/3] arm64: dts: rockchip: Describe RK3328 GPIO_MUTE users
+Date: Tue, 18 Feb 2020 21:32:00 +0000
+
+Add explicit properties to describe existing boards' GPIO_MUTE usage
+for the analog codec.
+
+Signed-off-by: Robin Murphy <robin.murphy@arm.com>
+---
+
+v2: no change
+
+ arch/arm64/boot/dts/rockchip/rk3328-rock64.dts | 1 +
+ 1 files changed, 1 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+index 62936b432f9a..bf3e546f5266 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
++++ b/arch/arm64/boot/dts/rockchip/rk3328-rock64.dts
+@@ -104,6 +104,7 @@
+ };
+ 
+ &codec {
++	mute-gpios = <&grf_gpio 0 GPIO_ACTIVE_LOW>;
+ 	status = "okay";
+ 
+ 	port@0 {
diff --git a/target/linux/rockchip/patches-5.4/0030-hdmi_cec_fixes.patch b/target/linux/rockchip/patches-5.4/0030-hdmi_cec_fixes.patch
new file mode 100644
index 0000000000..70b94f3df8
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0030-hdmi_cec_fixes.patch
@@ -0,0 +1,510 @@
+From dc4eaa80dc3753167b487d80e60b38b936eea07e Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Mon, 18 Feb 2019 20:17:40 +0000
+Subject: [PATCH] [media] rc/keymaps: add keytable for Pine64 IR Remote
+ Controller
+
+This RC map is based on remote key schema at [1], the mouse button key
+did not have an obvious target and was mapped to KEY_CONTEXT_MENU.
+
+[1] http://files.pine64.org/doc/Pine%20A64%20Schematic/remote-wit-logo.jpg
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ drivers/media/rc/keymaps/Makefile    |  1 +
+ drivers/media/rc/keymaps/rc-pine64.c | 59 ++++++++++++++++++++++++++++++++++++
+ include/media/rc-map.h               |  1 +
+ 3 files changed, 61 insertions(+)
+ create mode 100644 drivers/media/rc/keymaps/rc-pine64.c
+
+diff --git a/drivers/media/rc/keymaps/Makefile b/drivers/media/rc/keymaps/Makefile
+index a56fc634d2d6..7b24df2ecd93 100644
+--- a/drivers/media/rc/keymaps/Makefile
++++ b/drivers/media/rc/keymaps/Makefile
+@@ -78,6 +78,7 @@ obj-$(CONFIG_RC_MAP) += rc-adstech-dvb-t-pci.o \
+ 			rc-npgtech.o \
+ 			rc-odroid.o \
+ 			rc-pctv-sedna.o \
++			rc-pine64.o \
+ 			rc-pinnacle-color.o \
+ 			rc-pinnacle-grey.o \
+ 			rc-pinnacle-pctv-hd.o \
+diff --git a/drivers/media/rc/keymaps/rc-pine64.c b/drivers/media/rc/keymaps/rc-pine64.c
+new file mode 100644
+index 000000000000..94e5624f63f4
+--- /dev/null
++++ b/drivers/media/rc/keymaps/rc-pine64.c
+@@ -0,0 +1,59 @@
++// SPDX-License-Identifier: GPL-2.0+
++// Keytable for Pine64 IR Remote Controller
++// Copyright (c) 2017 Jonas Karlman
++
++#include <media/rc-map.h>
++#include <linux/module.h>
++
++static struct rc_map_table pine64[] = {
++	{ 0x404000, KEY_NUMERIC_0 },
++	{ 0x404001, KEY_NUMERIC_1 },
++	{ 0x404002, KEY_NUMERIC_2 },
++	{ 0x404003, KEY_NUMERIC_3 },
++	{ 0x404004, KEY_NUMERIC_4 },
++	{ 0x404005, KEY_NUMERIC_5 },
++	{ 0x404006, KEY_NUMERIC_6 },
++	{ 0x404007, KEY_NUMERIC_7 },
++	{ 0x404008, KEY_NUMERIC_8 },
++	{ 0x404009, KEY_NUMERIC_9 },
++	{ 0x40400a, KEY_MUTE },
++	{ 0x40400b, KEY_UP },
++	{ 0x40400c, KEY_BACKSPACE },
++	{ 0x40400d, KEY_OK },
++	{ 0x40400e, KEY_DOWN },
++	{ 0x404010, KEY_LEFT },
++	{ 0x404011, KEY_RIGHT },
++	{ 0x404017, KEY_VOLUMEDOWN },
++	{ 0x404018, KEY_VOLUMEUP },
++	{ 0x40401a, KEY_HOME },
++	{ 0x40401d, KEY_MENU },
++	{ 0x40401f, KEY_WWW },
++	{ 0x404045, KEY_BACK },
++	{ 0x404047, KEY_CONTEXT_MENU },
++	{ 0x40404d, KEY_POWER },
++};
++
++static struct rc_map_list pine64_map = {
++	.map = {
++		.scan     = pine64,
++		.size     = ARRAY_SIZE(pine64),
++		.rc_proto = RC_PROTO_NECX,
++		.name     = RC_MAP_PINE64,
++	}
++};
++
++static int __init init_rc_map_pine64(void)
++{
++	return rc_map_register(&pine64_map);
++}
++
++static void __exit exit_rc_map_pine64(void)
++{
++	rc_map_unregister(&pine64_map);
++}
++
++module_init(init_rc_map_pine64)
++module_exit(exit_rc_map_pine64)
++
++MODULE_LICENSE("GPL");
++MODULE_AUTHOR("Jonas Karlman");
+diff --git a/include/media/rc-map.h b/include/media/rc-map.h
+index afd2ab31bdf2..d420172fb911 100644
+--- a/include/media/rc-map.h
++++ b/include/media/rc-map.h
+@@ -231,6 +231,7 @@ struct rc_map *rc_map_get(const char *name);
+ #define RC_MAP_NPGTECH                   "rc-npgtech"
+ #define RC_MAP_ODROID                    "rc-odroid"
+ #define RC_MAP_PCTV_SEDNA                "rc-pctv-sedna"
++#define RC_MAP_PINE64                    "rc-pine64"
+ #define RC_MAP_PINNACLE_COLOR            "rc-pinnacle-color"
+ #define RC_MAP_PINNACLE_GREY             "rc-pinnacle-grey"
+ #define RC_MAP_PINNACLE_PCTV_HD          "rc-pinnacle-pctv-hd"
+
+From 45fb9a7ad0baf6bb5537d40d02379690f6011acf Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Wed, 7 Aug 2019 15:11:23 +0000
+Subject: [PATCH] ASoC: hdmi-codec: reorder channel allocation list
+
+Wrong channel allocation is selected by hdmi_codec_get_ch_alloc_table_idx().
+
+E.g when ELD reports FL|FR|LFE|FC|RL|RR or FL|FR|LFE|FC|RL|RR|RC|RLC|RRC
+
+ca_id 0x01 with speaker mask FL|FR|LFE gets selected instead of
+ca_id 0x03 with speaker mask FL|FR|LFE|FC for 4 channels
+
+and
+
+ca_id 0x04 with speaker mask FL|FR|RC gets selected instead of
+ca_id 0x0b with speaker mask FL|FR|LFE|FC|RL|RR for 6 channels
+
+Fix this by reorder the channel allocation list with
+most specific speaker mask at the top.
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ sound/soc/codecs/hdmi-codec.c | 115 +++++++++++++++++++-----------------------
+ 1 file changed, 53 insertions(+), 62 deletions(-)
+
+diff --git a/sound/soc/codecs/hdmi-codec.c b/sound/soc/codecs/hdmi-codec.c
+index 543363102d03..42bf1334f464 100644
+--- a/sound/soc/codecs/hdmi-codec.c
++++ b/sound/soc/codecs/hdmi-codec.c
+@@ -189,84 +189,75 @@ static const struct snd_pcm_chmap_elem hdmi_codec_8ch_chmaps[] = {
+ /*
+  * hdmi_codec_channel_alloc: speaker configuration available for CEA
+  *
+- * This is an ordered list that must match with hdmi_codec_8ch_chmaps struct
++ * This is an ordered list where ca_id must exist in hdmi_codec_8ch_chmaps
+  * The preceding ones have better chances to be selected by
+  * hdmi_codec_get_ch_alloc_table_idx().
+  */
+ static const struct hdmi_codec_cea_spk_alloc hdmi_codec_channel_alloc[] = {
+ 	{ .ca_id = 0x00, .n_ch = 2,
+-	  .mask = FL | FR},
+-	/* 2.1 */
+-	{ .ca_id = 0x01, .n_ch = 4,
+-	  .mask = FL | FR | LFE},
+-	/* Dolby Surround */
++	  .mask = FL | FR },
++	{ .ca_id = 0x03, .n_ch = 4,
++	  .mask = FL | FR | LFE | FC },
+ 	{ .ca_id = 0x02, .n_ch = 4,
+ 	  .mask = FL | FR | FC },
+-	/* surround51 */
++	{ .ca_id = 0x01, .n_ch = 4,
++	  .mask = FL | FR | LFE },
+ 	{ .ca_id = 0x0b, .n_ch = 6,
+-	  .mask = FL | FR | LFE | FC | RL | RR},
+-	/* surround40 */
+-	{ .ca_id = 0x08, .n_ch = 6,
+-	  .mask = FL | FR | RL | RR },
+-	/* surround41 */
+-	{ .ca_id = 0x09, .n_ch = 6,
+-	  .mask = FL | FR | LFE | RL | RR },
+-	/* surround50 */
++	  .mask = FL | FR | LFE | FC | RL | RR },
+ 	{ .ca_id = 0x0a, .n_ch = 6,
+ 	  .mask = FL | FR | FC | RL | RR },
+-	/* 6.1 */
+-	{ .ca_id = 0x0f, .n_ch = 8,
+-	  .mask = FL | FR | LFE | FC | RL | RR | RC },
+-	/* surround71 */
++	{ .ca_id = 0x09, .n_ch = 6,
++	  .mask = FL | FR | LFE | RL | RR },
++	{ .ca_id = 0x08, .n_ch = 6,
++	  .mask = FL | FR | RL | RR },
++	{ .ca_id = 0x07, .n_ch = 6,
++	  .mask = FL | FR | LFE | FC | RC },
++	{ .ca_id = 0x06, .n_ch = 6,
++	  .mask = FL | FR | FC | RC },
++	{ .ca_id = 0x05, .n_ch = 6,
++	  .mask = FL | FR | LFE | RC },
++	{ .ca_id = 0x04, .n_ch = 6,
++	  .mask = FL | FR | RC },
+ 	{ .ca_id = 0x13, .n_ch = 8,
+ 	  .mask = FL | FR | LFE | FC | RL | RR | RLC | RRC },
+-	/* others */
+-	{ .ca_id = 0x03, .n_ch = 8,
+-	  .mask = FL | FR | LFE | FC },
+-	{ .ca_id = 0x04, .n_ch = 8,
+-	  .mask = FL | FR | RC},
+-	{ .ca_id = 0x05, .n_ch = 8,
+-	  .mask = FL | FR | LFE | RC },
+-	{ .ca_id = 0x06, .n_ch = 8,
+-	  .mask = FL | FR | FC | RC },
+-	{ .ca_id = 0x07, .n_ch = 8,
+-	  .mask = FL | FR | LFE | FC | RC },
+-	{ .ca_id = 0x0c, .n_ch = 8,
+-	  .mask = FL | FR | RC | RL | RR },
+-	{ .ca_id = 0x0d, .n_ch = 8,
+-	  .mask = FL | FR | LFE | RL | RR | RC },
+-	{ .ca_id = 0x0e, .n_ch = 8,
+-	  .mask = FL | FR | FC | RL | RR | RC },
+-	{ .ca_id = 0x10, .n_ch = 8,
+-	  .mask = FL | FR | RL | RR | RLC | RRC },
+-	{ .ca_id = 0x11, .n_ch = 8,
+-	  .mask = FL | FR | LFE | RL | RR | RLC | RRC },
++	{ .ca_id = 0x1f, .n_ch = 8,
++	  .mask = FL | FR | LFE | FC | RL | RR | FLC | FRC },
+ 	{ .ca_id = 0x12, .n_ch = 8,
+ 	  .mask = FL | FR | FC | RL | RR | RLC | RRC },
+-	{ .ca_id = 0x14, .n_ch = 8,
+-	  .mask = FL | FR | FLC | FRC },
+-	{ .ca_id = 0x15, .n_ch = 8,
+-	  .mask = FL | FR | LFE | FLC | FRC },
+-	{ .ca_id = 0x16, .n_ch = 8,
+-	  .mask = FL | FR | FC | FLC | FRC },
+-	{ .ca_id = 0x17, .n_ch = 8,
+-	  .mask = FL | FR | LFE | FC | FLC | FRC },
+-	{ .ca_id = 0x18, .n_ch = 8,
+-	  .mask = FL | FR | RC | FLC | FRC },
+-	{ .ca_id = 0x19, .n_ch = 8,
+-	  .mask = FL | FR | LFE | RC | FLC | FRC },
+-	{ .ca_id = 0x1a, .n_ch = 8,
+-	  .mask = FL | FR | RC | FC | FLC | FRC },
+-	{ .ca_id = 0x1b, .n_ch = 8,
+-	  .mask = FL | FR | LFE | RC | FC | FLC | FRC },
+-	{ .ca_id = 0x1c, .n_ch = 8,
+-	  .mask = FL | FR | RL | RR | FLC | FRC },
+-	{ .ca_id = 0x1d, .n_ch = 8,
+-	  .mask = FL | FR | LFE | RL | RR | FLC | FRC },
+ 	{ .ca_id = 0x1e, .n_ch = 8,
+ 	  .mask = FL | FR | FC | RL | RR | FLC | FRC },
+-	{ .ca_id = 0x1f, .n_ch = 8,
+-	  .mask = FL | FR | LFE | FC | RL | RR | FLC | FRC },
++	{ .ca_id = 0x11, .n_ch = 8,
++	  .mask = FL | FR | LFE | RL | RR | RLC | RRC },
++	{ .ca_id = 0x1d, .n_ch = 8,
++	  .mask = FL | FR | LFE | RL | RR | FLC | FRC },
++	{ .ca_id = 0x10, .n_ch = 8,
++	  .mask = FL | FR | RL | RR | RLC | RRC },
++	{ .ca_id = 0x1c, .n_ch = 8,
++	  .mask = FL | FR | RL | RR | FLC | FRC },
++	{ .ca_id = 0x0f, .n_ch = 8,
++	  .mask = FL | FR | LFE | FC | RL | RR | RC },
++	{ .ca_id = 0x1b, .n_ch = 8,
++	  .mask = FL | FR | LFE | RC | FC | FLC | FRC },
++	{ .ca_id = 0x0e, .n_ch = 8,
++	  .mask = FL | FR | FC | RL | RR | RC },
++	{ .ca_id = 0x1a, .n_ch = 8,
++	  .mask = FL | FR | RC | FC | FLC | FRC },
++	{ .ca_id = 0x0d, .n_ch = 8,
++	  .mask = FL | FR | LFE | RL | RR | RC },
++	{ .ca_id = 0x19, .n_ch = 8,
++	  .mask = FL | FR | LFE | RC | FLC | FRC },
++	{ .ca_id = 0x0c, .n_ch = 8,
++	  .mask = FL | FR | RC | RL | RR },
++	{ .ca_id = 0x18, .n_ch = 8,
++	  .mask = FL | FR | RC | FLC | FRC },
++	{ .ca_id = 0x17, .n_ch = 8,
++	  .mask = FL | FR | LFE | FC | FLC | FRC },
++	{ .ca_id = 0x16, .n_ch = 8,
++	  .mask = FL | FR | FC | FLC | FRC },
++	{ .ca_id = 0x15, .n_ch = 8,
++	  .mask = FL | FR | LFE | FLC | FRC },
++	{ .ca_id = 0x14, .n_ch = 8,
++	  .mask = FL | FR | FLC | FRC },
+ };
+ 
+ struct hdmi_codec_priv {
+
+From 933ddafeb4621f0e2cdf18022223115569e4659e Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Tue, 1 Oct 2019 20:52:42 +0000
+Subject: [PATCH] media: cec-adap: add debounce support when setting an invalid
+ phys addr
+
+When EDID is refreshed, HDMI cable is unplugged/replugged or
+an AVR is power cycled the CEC phys addr gets invalidated.
+
+This can cause some disruption of CEC communication when
+adapter is being reconfigured.
+
+Add a debounce module option that can be used to debounce setting
+an invalid phys addr. Default is not to use debouncing.
+
+Using a configured debounce of e.g. 5000 ms, cec reconfiguring
+could be avoided when AVR was power cycled on my setup.
+
+Power off AVR (default cec.debounce=0):
+[  101.536866] cec-dw_hdmi: new physical address f.f.f.f
+[  102.495686] cec-dw_hdmi: new physical address 2.1.0.0
+[  102.495913] cec-dw_hdmi: physical address: 2.1.0.0, claim 1 logical addresses
+[  102.628574] cec-dw_hdmi: config: la 1 pa 2.1.0.0
+[  105.130115] cec-dw_hdmi: new physical address f.f.f.f
+[  106.979705] cec-dw_hdmi: new physical address 2.1.0.0
+[  106.979872] cec-dw_hdmi: physical address: 2.1.0.0, claim 1 logical addresses
+[  107.112399] cec-dw_hdmi: config: la 1 pa 2.1.0.0
+[  108.979408] cec-dw_hdmi: reported physical address 2.0.0.0 for logical address 5
+[  109.205386] cec-dw_hdmi: reported physical address 2.0.0.0 for logical address 11
+
+Power on AVR (default cec.debounce=0):
+[  158.398447] cec-dw_hdmi: new physical address f.f.f.f
+[  161.977714] cec-dw_hdmi: new physical address 2.1.0.0
+[  161.978766] cec-dw_hdmi: physical address: 2.1.0.0, claim 1 logical addresses
+[  162.115624] cec-dw_hdmi: config: la 1 pa 2.1.0.0
+[  162.402750] cec-dw_hdmi: new physical address f.f.f.f
+[  162.403389] cec-dw_hdmi: cec_transmit_msg_fh: adapter is unconfigured
+[  162.886757] cec-dw_hdmi: new physical address 2.1.0.0
+[  162.886964] cec-dw_hdmi: physical address: 2.1.0.0, claim 1 logical addresses
+[  163.510725] cec-dw_hdmi: config: la 1 pa 2.1.0.0
+[  173.034200] cec-dw_hdmi: message 10 89 02 05 timed out
+
+Power off AVR (cec.debounce=5000):
+[  251.720471] cec-dw_hdmi: reported physical address 2.0.0.0 for logical address 5
+[  251.922432] cec-dw_hdmi: reported physical address 2.0.0.0 for logical address 11
+
+Power on AVR (cec.debounce=5000):
+[  291.154262] cec-dw_hdmi: reported physical address 2.0.0.0 for logical address 5
+[  291.296199] cec-dw_hdmi: reported physical address 2.0.0.0 for logical address 11
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ Documentation/media/uapi/cec/cec-intro.rst |  8 ++++++++
+ drivers/media/cec/cec-adap.c               |  9 ++++++++-
+ drivers/media/cec/cec-core.c               | 18 ++++++++++++++++++
+ drivers/media/cec/cec-priv.h               |  1 +
+ include/media/cec.h                        |  2 ++
+ 5 files changed, 37 insertions(+), 1 deletion(-)
+
+diff --git a/Documentation/media/uapi/cec/cec-intro.rst b/Documentation/media/uapi/cec/cec-intro.rst
+index 05088fcefe81..9bfd11ef987b 100644
+--- a/Documentation/media/uapi/cec/cec-intro.rst
++++ b/Documentation/media/uapi/cec/cec-intro.rst
+@@ -47,3 +47,11 @@ provides three tools to handle CEC:
+   determine how compliant the CEC implementation is.
+ 
+ - cec-follower: emulates a CEC follower.
++
++Debouncing
++----------
++
++The ``debounce_ms`` option is a module parameter that can be used to enabled
++debouncing of setting invalid physical address.
++
++FIXME: Make a section "1.1 Debouncing" that explains this module option.
+diff --git a/drivers/media/cec/cec-adap.c b/drivers/media/cec/cec-adap.c
+index 9340435a94a0..266bf704b0fd 100644
+--- a/drivers/media/cec/cec-adap.c
++++ b/drivers/media/cec/cec-adap.c
+@@ -1595,8 +1595,15 @@ void cec_s_phys_addr(struct cec_adapter *adap, u16 phys_addr, bool block)
+ 	if (IS_ERR_OR_NULL(adap))
+ 		return;
+ 
++	cancel_delayed_work_sync(&adap->debounce_work);
++
+ 	mutex_lock(&adap->lock);
+-	__cec_s_phys_addr(adap, phys_addr, block);
++	if (cec_debounce_ms > 0 && !block &&
++	    phys_addr == CEC_PHYS_ADDR_INVALID && adap->phys_addr != phys_addr)
++		schedule_delayed_work(&adap->debounce_work,
++				      msecs_to_jiffies(cec_debounce_ms));
++	else
++		__cec_s_phys_addr(adap, phys_addr, block);
+ 	mutex_unlock(&adap->lock);
+ }
+ EXPORT_SYMBOL_GPL(cec_s_phys_addr);
+diff --git a/drivers/media/cec/cec-core.c b/drivers/media/cec/cec-core.c
+index db7adffcdc76..24405e96e785 100644
+--- a/drivers/media/cec/cec-core.c
++++ b/drivers/media/cec/cec-core.c
+@@ -28,6 +28,10 @@ static bool debug_phys_addr;
+ module_param(debug_phys_addr, bool, 0644);
+ MODULE_PARM_DESC(debug_phys_addr, "add CEC_CAP_PHYS_ADDR if set");
+ 
++int cec_debounce_ms;
++module_param_named(debounce_ms, cec_debounce_ms, int, 0644);
++MODULE_PARM_DESC(debounce_ms, "invalid physical address debounce time in ms");
++
+ static dev_t cec_dev_t;
+ 
+ /* Active devices */
+@@ -174,6 +178,8 @@ static void cec_devnode_unregister(struct cec_adapter *adap)
+ 	devnode->unregistered = true;
+ 	mutex_unlock(&devnode->lock);
+ 
++	cancel_delayed_work_sync(&adap->debounce_work);
++
+ 	mutex_lock(&adap->lock);
+ 	__cec_s_phys_addr(adap, CEC_PHYS_ADDR_INVALID, false);
+ 	__cec_s_log_addrs(adap, NULL, false);
+@@ -250,6 +256,17 @@ static const struct file_operations cec_error_inj_fops = {
+ };
+ #endif
+ 
++static void cec_s_phys_addr_debounce(struct work_struct *work)
++{
++	struct delayed_work *delayed_work = to_delayed_work(work);
++	struct cec_adapter *adap =
++		container_of(delayed_work, struct cec_adapter, debounce_work);
++
++	mutex_lock(&adap->lock);
++	__cec_s_phys_addr(adap, CEC_PHYS_ADDR_INVALID, false);
++	mutex_unlock(&adap->lock);
++}
++
+ struct cec_adapter *cec_allocate_adapter(const struct cec_adap_ops *ops,
+ 					 void *priv, const char *name, u32 caps,
+ 					 u8 available_las)
+@@ -288,6 +305,7 @@ struct cec_adapter *cec_allocate_adapter(const struct cec_adap_ops *ops,
+ 	INIT_LIST_HEAD(&adap->transmit_queue);
+ 	INIT_LIST_HEAD(&adap->wait_queue);
+ 	init_waitqueue_head(&adap->kthread_waitq);
++	INIT_DELAYED_WORK(&adap->debounce_work, cec_s_phys_addr_debounce);
+ 
+ 	/* adap->devnode initialization */
+ 	INIT_LIST_HEAD(&adap->devnode.fhs);
+diff --git a/drivers/media/cec/cec-priv.h b/drivers/media/cec/cec-priv.h
+index 7bdf855aaecd..e8b1fc0a22c4 100644
+--- a/drivers/media/cec/cec-priv.h
++++ b/drivers/media/cec/cec-priv.h
+@@ -27,6 +27,7 @@ static inline bool msg_is_raw(const struct cec_msg *msg)
+ 
+ /* cec-core.c */
+ extern int cec_debug;
++extern int cec_debounce_ms;
+ int cec_get_device(struct cec_devnode *devnode);
+ void cec_put_device(struct cec_devnode *devnode);
+ 
+diff --git a/include/media/cec.h b/include/media/cec.h
+index 0a4f69cc9dd4..3048b3f2219c 100644
+--- a/include/media/cec.h
++++ b/include/media/cec.h
+@@ -164,6 +164,8 @@ struct cec_adapter {
+ 	wait_queue_head_t kthread_waitq;
+ 	wait_queue_head_t waitq;
+ 
++	struct delayed_work debounce_work;
++
+ 	const struct cec_adap_ops *ops;
+ 	void *priv;
+ 	u32 capabilities;
+
+From b7600b1f821f4f110b2068841df5229b7eca340c Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Tue, 26 Feb 2019 20:45:14 +0000
+Subject: [PATCH] WIP: dw-hdmi-cec: sleep 100ms on error
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ drivers/gpu/drm/bridge/synopsys/dw-hdmi-cec.c | 19 +++++++++++++++++--
+ 1 file changed, 17 insertions(+), 2 deletions(-)
+
+diff --git a/drivers/gpu/drm/bridge/synopsys/dw-hdmi-cec.c b/drivers/gpu/drm/bridge/synopsys/dw-hdmi-cec.c
+index 70ab4fbdc23e..f6a85f73b90d 100644
+--- a/drivers/gpu/drm/bridge/synopsys/dw-hdmi-cec.c
++++ b/drivers/gpu/drm/bridge/synopsys/dw-hdmi-cec.c
+@@ -4,6 +4,7 @@
+  *
+  * Copyright (C) 2015-2017 Russell King.
+  */
++#include <linux/delay.h>
+ #include <linux/interrupt.h>
+ #include <linux/io.h>
+ #include <linux/module.h>
+@@ -129,8 +130,16 @@ static irqreturn_t dw_hdmi_cec_hardirq(int irq, void *data)
+ 
+ 	dw_hdmi_write(cec, stat, HDMI_IH_CEC_STAT0);
+ 
+-	if (stat & CEC_STAT_ERROR_INIT) {
+-		cec->tx_status = CEC_TX_STATUS_ERROR;
++	/*
++	 * Status with both done and error_initiator bits have been seen
++	 * on Rockchip RK3328 devices, transmit attempt seems to have failed
++	 * when this happens, report as low drive and block cec-framework
++	 * 100ms before core retransmits the failed message, this seems to
++	 * mitigate the issue with failed transmit attempts.
++	 */
++	if ((stat & (CEC_STAT_DONE|CEC_STAT_ERROR_INIT)) == (CEC_STAT_DONE|CEC_STAT_ERROR_INIT)) {
++		pr_info("dw_hdmi_cec_hardirq: stat=%02x LOW_DRIVE\n", stat);
++		cec->tx_status = CEC_TX_STATUS_LOW_DRIVE;
+ 		cec->tx_done = true;
+ 		ret = IRQ_WAKE_THREAD;
+ 	} else if (stat & CEC_STAT_DONE) {
+@@ -141,6 +150,10 @@ static irqreturn_t dw_hdmi_cec_hardirq(int irq, void *data)
+ 		cec->tx_status = CEC_TX_STATUS_NACK;
+ 		cec->tx_done = true;
+ 		ret = IRQ_WAKE_THREAD;
++	} else if (stat & CEC_STAT_ERROR_INIT) {
++		cec->tx_status = CEC_TX_STATUS_ERROR;
++		cec->tx_done = true;
++		ret = IRQ_WAKE_THREAD;
+ 	}
+ 
+ 	if (stat & CEC_STAT_EOM) {
+@@ -173,6 +186,8 @@ static irqreturn_t dw_hdmi_cec_thread(int irq, void *data)
+ 
+ 	if (cec->tx_done) {
+ 		cec->tx_done = false;
++		if (cec->tx_status == CEC_TX_STATUS_LOW_DRIVE)
++			msleep(100);
+ 		cec_transmit_attempt_done(adap, cec->tx_status);
+ 	}
+ 	if (cec->rx_done) {
diff --git a/target/linux/rockchip/patches-5.4/0031-mmc_rename.patch b/target/linux/rockchip/patches-5.4/0031-mmc_rename.patch
new file mode 100644
index 0000000000..7f95ee6b2d
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0031-mmc_rename.patch
@@ -0,0 +1,56 @@
+From 3ef7c2558f31745588473b75a655894b37e62116 Mon Sep 17 00:00:00 2001
+From: Johan Jonker <jbx6244@gmail.com>
+Date: Wed, 15 Jan 2020 19:52:44 +0100
+Subject: arm64: dts: rockchip: rename dwmmc node names to mmc
+
+Current dts files with 'dwmmc' nodes are manually verified.
+In order to automate this process rockchip-dw-mshc.txt
+has to be converted to yaml. In the new setup
+rockchip-dw-mshc.yaml will inherit properties from
+mmc-controller.yaml and synopsys-dw-mshc-common.yaml.
+'dwmmc' will no longer be a valid name for a node,
+so change them all to 'mmc'
+
+Signed-off-by: Johan Jonker <jbx6244@gmail.com>
+Link: https://lore.kernel.org/r/20200115185244.18149-2-jbx6244@gmail.com
+Signed-off-by: Heiko Stuebner <heiko@sntech.de>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 6 +++---
+ 1 file changed, 3 insertions(+), 3 deletions(-)
+
+(limited to 'arch/arm64/boot/dts/rockchip/rk3328.dtsi')
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index c9ff1188bd7b..1f53ead52c7f 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -854,7 +854,7 @@
+ 		};
+ 	};
+ 
+-	sdmmc: dwmmc@ff500000 {
++	sdmmc: mmc@ff500000 {
+ 		compatible = "rockchip,rk3328-dw-mshc", "rockchip,rk3288-dw-mshc";
+ 		reg = <0x0 0xff500000 0x0 0x4000>;
+ 		interrupts = <GIC_SPI 12 IRQ_TYPE_LEVEL_HIGH>;
+@@ -866,7 +866,7 @@
+ 		status = "disabled";
+ 	};
+ 
+-	sdio: dwmmc@ff510000 {
++	sdio: mmc@ff510000 {
+ 		compatible = "rockchip,rk3328-dw-mshc", "rockchip,rk3288-dw-mshc";
+ 		reg = <0x0 0xff510000 0x0 0x4000>;
+ 		interrupts = <GIC_SPI 13 IRQ_TYPE_LEVEL_HIGH>;
+@@ -878,7 +878,7 @@
+ 		status = "disabled";
+ 	};
+ 
+-	emmc: dwmmc@ff520000 {
++	emmc: mmc@ff520000 {
+ 		compatible = "rockchip,rk3328-dw-mshc", "rockchip,rk3288-dw-mshc";
+ 		reg = <0x0 0xff520000 0x0 0x4000>;
+ 		interrupts = <GIC_SPI 14 IRQ_TYPE_LEVEL_HIGH>;
+-- 
+cgit 1.2-0.3.lf.el7
+
diff --git a/target/linux/rockchip/patches-5.4/0032-add_hwmon_support.patch b/target/linux/rockchip/patches-5.4/0032-add_hwmon_support.patch
new file mode 100644
index 0000000000..3e5e863970
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0032-add_hwmon_support.patch
@@ -0,0 +1,92 @@
+From f895f1f4de0b7252f29e7e5779727b303df9e58d Mon Sep 17 00:00:00 2001
+From: schaecsn <schaecsn@gmx.net>
+Date: Sun, 17 Nov 2019 21:24:13 -0800
+Subject: [PATCH] thermal: rockchip: enable hwmon
+
+Enable hwmon for the soc and gpu temperature sensors.
+
+Signed-off-by: Stefan Schaeckeler <schaecsn@gmx.net>
+---
+ drivers/thermal/rockchip_thermal.c | 12 +++++++++++-
+ 1 file changed, 11 insertions(+), 1 deletion(-)
+
+diff --git a/drivers/thermal/rockchip_thermal.c b/drivers/thermal/rockchip_thermal.c
+index 343c2f5c5a25..e47c60010259 100644
+--- a/drivers/thermal/rockchip_thermal.c
++++ b/drivers/thermal/rockchip_thermal.c
+@@ -19,6 +19,8 @@
+ #include <linux/mfd/syscon.h>
+ #include <linux/pinctrl/consumer.h>
+ 
++#include "thermal_hwmon.h"
++
+ /**
+  * If the temperature over a period of time High,
+  * the resulting TSHUT gave CRU module,let it reset the entire chip,
+@@ -1321,8 +1323,15 @@ static int rockchip_thermal_probe(struct platform_device *pdev)
+ 
+ 	thermal->chip->control(thermal->regs, true);
+ 
+-	for (i = 0; i < thermal->chip->chn_num; i++)
++	for (i = 0; i < thermal->chip->chn_num; i++) {
+ 		rockchip_thermal_toggle_sensor(&thermal->sensors[i], true);
++		thermal->sensors[i].tzd->tzp->no_hwmon = false;
++		error = thermal_add_hwmon_sysfs(thermal->sensors[i].tzd);
++		if (error)
++			dev_warn(&pdev->dev,
++				 "failed to register sensor %d with hwmon: %d\n",
++				 i, error);
++	}
+ 
+ 	platform_set_drvdata(pdev, thermal);
+ 
+@@ -1344,6 +1353,7 @@ static int rockchip_thermal_remove(struct platform_device *pdev)
+ 	for (i = 0; i < thermal->chip->chn_num; i++) {
+ 		struct rockchip_thermal_sensor *sensor = &thermal->sensors[i];
+ 
++		thermal_remove_hwmon_sysfs(sensor->tzd);
+ 		rockchip_thermal_toggle_sensor(sensor, false);
+ 	}
+ 
+
+From b5bcb54fe763aa9f40bae7af7e0629a3a6b93a52 Mon Sep 17 00:00:00 2001
+From: Robin Murphy <robin.murphy@arm.com>
+Date: Thu, 28 Nov 2019 20:59:27 +0000
+Subject: [PATCH] arm64: dts: rockchip: Add GPU cooling device for RK3399
+
+As for RK3288, now that we have a binding for the GPU we can
+hook up the missing cooling device for the thermal zone.
+
+Signed-off-by: Robin Murphy <robin.murphy@arm.com>
+---
+ arch/arm64/boot/dts/rockchip/rk3399.dtsi | 9 +++++++++
+ 1 file changed, 9 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3399.dtsi b/arch/arm64/boot/dts/rockchip/rk3399.dtsi
+index e62ea0e2b657..aa0838adb224 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3399.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3399.dtsi
+@@ -828,6 +828,14 @@
+ 					type = "critical";
+ 				};
+ 			};
++
++			cooling-maps {
++				map0 {
++					trip = <&gpu_alert0>;
++					cooling-device =
++						<&gpu THERMAL_NO_LIMIT THERMAL_NO_LIMIT>;
++				};
++			};
+ 		};
+ 	};
+ 
+@@ -1887,6 +1895,7 @@
+ 			     <GIC_SPI 21 IRQ_TYPE_LEVEL_HIGH 0>;
+ 		interrupt-names = "gpu", "job", "mmu";
+ 		clocks = <&cru ACLK_GPU>;
++		#cooling-cells = <2>;
+ 		power-domains = <&power RK3399_PD_GPU>;
+ 		status = "disabled";
+ 	};
+
diff --git a/target/linux/rockchip/patches-5.4/0033-add_mmc_poweroff.patch b/target/linux/rockchip/patches-5.4/0033-add_mmc_poweroff.patch
new file mode 100644
index 0000000000..ed0078c5ae
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0033-add_mmc_poweroff.patch
@@ -0,0 +1,94 @@
+From 1049f9202ff060e16121c74fb712daea48979e42 Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Fri, 11 Oct 2019 08:01:37 +0000
+Subject: [PATCH] mmc: dw_mmc: add power_off callback
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ drivers/mmc/host/dw_mmc.c | 3 +++
+ drivers/mmc/host/dw_mmc.h | 1 +
+ 2 files changed, 4 insertions(+)
+
+diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
+index 79c55c7b4afd..84557cdecf2a 100644
+--- a/drivers/mmc/host/dw_mmc.c
++++ b/drivers/mmc/host/dw_mmc.c
+@@ -1493,6 +1493,9 @@ static void dw_mci_set_ios(struct mmc_host *mmc, struct mmc_ios *ios)
+ 			regulator_disable(mmc->supply.vqmmc);
+ 		slot->host->vqmmc_enabled = false;
+ 
++		if (drv_data && drv_data->power_off)
++			drv_data->power_off(slot->host);
++
+ 		regs = mci_readl(slot->host, PWREN);
+ 		regs &= ~(1 << slot->id);
+ 		mci_writel(slot->host, PWREN, regs);
+diff --git a/drivers/mmc/host/dw_mmc.h b/drivers/mmc/host/dw_mmc.h
+index da5923a92e60..0b5c880364c5 100644
+--- a/drivers/mmc/host/dw_mmc.h
++++ b/drivers/mmc/host/dw_mmc.h
+@@ -563,5 +563,6 @@ struct dw_mci_drv_data {
+ 						struct mmc_ios *ios);
+ 	int		(*switch_voltage)(struct mmc_host *mmc,
+ 					  struct mmc_ios *ios);
++	void		(*power_off)(struct dw_mci *host);
+ };
+ #endif /* _DW_MMC_H_ */
+
+From 7f34988c4b1477568018aefdab4554f722985c29 Mon Sep 17 00:00:00 2001
+From: Jonas Karlman <jonas@kwiboo.se>
+Date: Fri, 11 Oct 2019 08:01:37 +0000
+Subject: [PATCH] mmc: dw_mmc-rockchip: try set vqmmc regulator to 3.3V on
+ power_off
+
+Signed-off-by: Jonas Karlman <jonas@kwiboo.se>
+---
+ drivers/mmc/host/dw_mmc-rockchip.c | 27 +++++++++++++++++++++++++++
+ 1 file changed, 27 insertions(+)
+
+diff --git a/drivers/mmc/host/dw_mmc-rockchip.c b/drivers/mmc/host/dw_mmc-rockchip.c
+index d4d02134848c..05410f90ddd3 100644
+--- a/drivers/mmc/host/dw_mmc-rockchip.c
++++ b/drivers/mmc/host/dw_mmc-rockchip.c
+@@ -24,6 +24,32 @@ struct dw_mci_rockchip_priv_data {
+ 	int			num_phases;
+ };
+ 
++static void dw_mci_rk3288_power_off(struct dw_mci *host)
++{
++	struct mmc_host	*mmc = host->slot->mmc;
++	struct mmc_ios *ios = &mmc->ios;
++	int old_signal_voltage;
++
++	if (IS_ERR(mmc->supply.vqmmc))
++		return;
++
++	if (mmc_host_is_spi(mmc))
++		return;
++
++	if (ios->vdd != 0 || ios->signal_voltage == MMC_SIGNAL_VOLTAGE_330)
++		return;
++
++	old_signal_voltage = ios->signal_voltage;
++
++	ios->signal_voltage = MMC_SIGNAL_VOLTAGE_330;
++	ios->vdd = fls(mmc->ocr_avail) - 1;
++
++	if (mmc_regulator_set_vqmmc(mmc, ios))
++		ios->signal_voltage = old_signal_voltage;
++
++	ios->vdd = 0;
++}
++
+ static void dw_mci_rk3288_set_ios(struct dw_mci *host, struct mmc_ios *ios)
+ {
+ 	struct dw_mci_rockchip_priv_data *priv = host->priv;
+@@ -319,6 +345,7 @@ static const struct dw_mci_drv_data rk3288_drv_data = {
+ 	.execute_tuning		= dw_mci_rk3288_execute_tuning,
+ 	.parse_dt		= dw_mci_rk3288_parse_dt,
+ 	.init			= dw_mci_rockchip_init,
++	.power_off		= dw_mci_rk3288_power_off,
+ };
+ 
+ static const struct of_device_id dw_mci_rockchip_match[] = {
+
diff --git a/target/linux/rockchip/patches-5.4/0040-fix_TX_checksumm_offload.patch b/target/linux/rockchip/patches-5.4/0040-fix_TX_checksumm_offload.patch
new file mode 100644
index 0000000000..f2debb3d57
--- /dev/null
+++ b/target/linux/rockchip/patches-5.4/0040-fix_TX_checksumm_offload.patch
@@ -0,0 +1,73 @@
+From patchwork Tue Feb 18 22:10:37 2020
+From: Carlos de Paula <me@carlosedp.com>
+Cc: papadakospan@gmail.com, jose.abreu@synopsys.com,
+        Carlos de Paula <me@carlosedp.com>,
+        Rob Herring <robh+dt@kernel.org>,
+        Mark Rutland <mark.rutland@arm.com>,
+        Heiko Stuebner <heiko@sntech.de>,
+        Robin Murphy <robin.murphy@arm.com>,
+        Jonas Karlman <jonas@kwiboo.se>,
+        Peter Geis <pgwipeout@gmail.com>,
+        Katsuhiro Suzuki <katsuhiro@katsuster.net>,
+        Johan Jonker <jbx6244@gmail.com>,
+        Philipp Tomsich <philipp.tomsich@theobroma-systems.com>,
+        Christoph Muellner <christoph.muellner@theobroma-systems.com>,
+        Enric Balletbo i Serra <enric.balletbo@collabora.com>,
+        Daniel Lezcano <daniel.lezcano@linaro.org>,
+        devicetree@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
+        linux-rockchip@lists.infradead.org, linux-kernel@vger.kernel.org
+Subject: [PATCH] arm64: dts: rockchip: Add txpbl node for RK3399/RK3328
+Date: Tue, 18 Feb 2020 17:10:37 -0500
+Sender: linux-kernel-owner@vger.kernel.org
+
+Some rockchip SoCs like the RK3399 and RK3328 exhibit an issue
+where tx checksumming does not work with packets larger than 1498.
+
+The default Programmable Buffer Length for TX in these GMAC's is
+not suitable for MTUs higher than 1498. The workaround is to disable
+TX offloading with 'ethtool -K eth0 tx off rx off' causing performance
+impacts as it disables hardware checksumming.
+
+This patch sets snps,txpbl to 0x4 which is a safe number tested ok for
+the most popular MTU value of 1500.
+
+For reference, see https://lkml.org/lkml/2019/4/1/1382.
+
+Signed-off-by: Carlos de Paula <me@carlosedp.com>
+---
+ arch/arm64/boot/dts/rockchip/rk3328.dtsi | 2 ++
+ arch/arm64/boot/dts/rockchip/rk3399.dtsi | 1 +
+ 2 files changed, 3 insertions(+)
+
+diff --git a/arch/arm64/boot/dts/rockchip/rk3328.dtsi b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+index 1f53ead52c7f..b7f1de4b7fd0 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3328.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3328.dtsi
+@@ -906,6 +906,7 @@
+ 		resets = <&cru SRST_GMAC2IO_A>;
+ 		reset-names = "stmmaceth";
+ 		rockchip,grf = <&grf>;
++		snps,txpbl = <0x4>;
+ 		status = "disabled";
+ 	};
+ 
+@@ -913,6 +914,7 @@
+ 		compatible = "rockchip,rk3328-gmac";
+ 		reg = <0x0 0xff550000 0x0 0x10000>;
+ 		rockchip,grf = <&grf>;
++		snps,txpbl = <0x4>;
+ 		interrupts = <GIC_SPI 21 IRQ_TYPE_LEVEL_HIGH>;
+ 		interrupt-names = "macirq";
+ 		clocks = <&cru SCLK_MAC2PHY_SRC>, <&cru SCLK_MAC2PHY_RXTX>,
+diff --git a/arch/arm64/boot/dts/rockchip/rk3399.dtsi b/arch/arm64/boot/dts/rockchip/rk3399.dtsi
+index 33cc21fcf4c1..cd5415d7e559 100644
+--- a/arch/arm64/boot/dts/rockchip/rk3399.dtsi
++++ b/arch/arm64/boot/dts/rockchip/rk3399.dtsi
+@@ -288,6 +288,7 @@
+ 		resets = <&cru SRST_A_GMAC>;
+ 		reset-names = "stmmaceth";
+ 		rockchip,grf = <&grf>;
++		snps,txpbl = <0x4>;
+ 		status = "disabled";
+ 	};
+ 
-- 
2.17.1

